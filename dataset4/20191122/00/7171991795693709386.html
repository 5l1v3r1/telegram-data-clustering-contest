<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://hackaday.com/2019/11/22/this-week-in-security-more-whatsapp-nextcry-hover-to-crash-and-android-permissions-bypass/"/>
    <meta property="og:site_name" content="Hackaday"/>
    <meta property="article:published_time" content="2019-11-22T00:00:00+00:00"/>
    <meta property="og:title" content="This Week In Security: More WhatsApp, Nextcry, Hover To Crash, And Android Permissions Bypass"/>
    <meta property="og:description" content="There is another WhatsApp flaw, but instead of malicious GIFs, this time it’s malicious mp4 files. Facebook announced the vulnerability late last week. An update has been released, so first g…"/>
  </head>
  <body>
    <article>
      <h1>This Week In Security: More WhatsApp, Nextcry, Hover To Crash, And Android Permissions Bypass</h1>
      <address><time datetime="2019-11-22T00:00:00+00:00">22 Nov 2019</time> by <a rel="author" href="https://hackaday.com/author/jonathanbennett492054495/" target="_blank">Jonathan Bennett</a></address>
      <p>There is another WhatsApp flaw, but instead of malicious GIFs, this time it’s malicious mp4 files. Facebook <a href="https://www.facebook.com/security/advisories/cve-2019-11931">announced the vulnerability</a> late last week. An update has been released, so first go make sure WhatsApp is updated. Facebook’s advisory is a bit light on the details, simply saying that a “stack-based buffer overflow” was possible as a result of “parsing the elementary stream metadata of an mp4 file”.</p>
      <p>Shortly after the bug was announced, <a href="https://github.com/kasif-dekel/whatsapp-rce-patched">a GitHub repository</a> popped up, with a claimed proof-of-concept mp4 file for CVE-2019-11931. (<a href="https://www.reddit.com/r/netsec/comments/dxcyjd/whatsapp_bug_cve201911931/f7pc300?utm_source=share&amp;utm_medium=web2x">Thanks to [justtransit] on Reddit for the link.</a>) I can’t easily test the PoC file, but we can take a look at it to see what the vulnerability is. What tools do we need to take a look? A hex editor is a good start. I’m using <code>GHex</code>, simply because it was available and easily installed on Fedora.</p>
      <figure>
        <img src="https://hackaday.com/wp-content/uploads/2019/11/Screenshot_20191120_221524.png?w=800"/>
        <figcaption>See the problem? Neither did I, at first.</figcaption>
      </figure>
      <p>The other tool we need is some documentation on how the mp4 format is supposed to be formatted. Mp4 has a storied history, descending from Apple’s QuickTime Movie format. <a href="https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/Metadata/Metadata.html">Apple’s developer documentation</a> was quite helpful in learning about mp4. I also referenced an <a href="http://xhelmboyx.tripod.com/formats/mp4-layout.txt">obscure archived geocities website</a> to answer a specific question that was unclear on the Apple page.</p>
      <p>So what is going on in that PoC mp4 file? An mp4 file is a binary format that contains binary values and UTF text. It’s generally in the format of a four bytes unsigned integer containing the field size, a four byte UTF field containing the human readable tag, and finally the binary data. These size/tag/data sets are referred to as atoms. Some atoms also contain additional header information, like bytes reserved for flags and version information. One of the atoms fields is the <code>meta</code> field, used for carrying metada information. This atom is defined as containing at least three subatoms, <code>hdlr</code>, <code>keys</code>, and <code>ilist</code>. The PoC file appears to have a valid meta atom, at first glance. I assume that WhatsApp’s parser was being fooled in the same way that I was fooled the first time I looked through the file.</p>
      <p>In looking for data on mp4 atoms, I discovered a useful tool, <a href="https://sourceforge.net/projects/atomicparsley/">AtomicParsley</a>. It’s a bit old, and the source needed some tinkering to get it to compile. The effort was worth it, as running AtomicParsley over the PoC file immediately revealed the attack. Do you see the problem now? The <code>meta</code> atom only totals 117 bytes, but it contains an unnamed atom nearly 7000 bytes long. That unnamed atom is actually the rest of the file. What’s going on, and why isn’t it obvious when looking at the file in the hex editor?</p>
      <figure>
        <img src="https://hackaday.com/wp-content/uploads/2019/11/Screenshot_20191120_225030-e1574387195172.png?w=800"/>
      </figure>
      <p>It looks like we have a <code>meta</code> atom that contains an <code>hdlr</code> atom. It makes sense, a four byte length followed by the <code>meta</code> tag, and then a four byte length and the <code>hdlr</code> tag. What isn’t apparent is that the <code>meta</code> atom is defined as having additional header information. The information on the mp4 format that I found states that after the <code>meta</code> string, the file should contain four null bytes, reserved for a version number and three bytes of flags. This shifts the parsing of the <code>meta</code> atom four bytes out of sync, and what appears to be another tag is actually interpreted as a field length. Instead of a length of 33 bytes, that atom has a size of 1.6 GB. This is obviously larger than the file itself, which is why AtomicParsley sees that atom as only being 7095 bytes long.</p>
      <p>The vulnerability announcement called the flaw a <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow">stack-based buffer overflow</a>. These are generally triggered by writing too much data into a stack variable. Let’s speculate just a bit on what the vulnerability likely looks like. A function responsible for parsing the header of an mp4 file declares a char array that gets stored on the stack, so not using <code>malloc</code>. That array is either set to a length the author considered “long enough”, or may even use a variable length array. Either way, the data is on the stack. It’s likely that this parser does sanity checking on the mp4 file before copying the data into the proper buffers. This sanity check may simply trust the stated length of the <code>meta</code> atom, or it may have been fooled by the almost properly formatted file. Either way, as the data is copied over, the missing four bytes results in the rest of the file being copied into that stack array, which isn’t actually large enough to contain it. The data is copied over whatever is on the stack, overwriting the return address and jumping program execution to wherever an attacker wants.</p>
      <p>Once the copy command reaches the end of the file, it probably raises an error and attempts to return from the current function. Since an attacker controls the return address and can write to the stack, that return call can jump directly into the attacker’s code.</p>
      <p><s>It’s unclear if this problem was found and disclosed by [Kasif Dekel], the researcher who uploaded the PoC to GitHub, or if it was being actively used in attacks.</s> Edit: I’ve gotten confirmation on this point. [Kasif Dekel], [Ronen Shustin], and [Kobi Hazak] were actively researching this flaw, but before they finalized their research and disclosed the vulnerability, WhatsApp independently discovered and patched it. The initial reports on this problem are coming from India. If any of you have any additional information on whether this vulnerability has been used in the wild, and particularly information on how to get a live sample of the malicious mp4, <a href="https://twitter.com/jp_bennett">please let me know about it</a>!</p>
      <h3>Nextcry Ransomware on Nextcloud</h3>
      <p>Remember <a href="https://hackaday.com/2019/11/01/this-week-in-security-project-zeros-iphone-bbc-the-onion-rooting-androids-and-more/">the NGINX problem</a> we discussed earlier this month? It seems that multiple Nextcloud installs were vulnerable to that attack, and a ransomware attack is actively being carried out against them. <a href="https://www.bleepingcomputer.com/news/security/new-nextcry-ransomware-encrypts-data-on-nextcloud-linux-servers/">Nextcry</a> encrypts the files stored on the Nextcloud instance, and demands just over $200 worth of Bitcoin for decryption. Just a reminder, this isn’t a flaw in Nextcloud itself, but following the official Nextcloud documentation on an NGINX server resulted in a vulnerable system.</p>
      <h3>Mouseover to Crash</h3>
      <p>A particularly nasty problem was fixed in Windows 8.1 and 10 this month. A PE (Portable Executable) <code>dll</code> <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1911">was discovered to crash the Windows kernel</a> when mousing over the file in Explorer. It’s possible this bug could be used to read protected memory, but the nastiness of this problem lies in how hard it is to get rid of the file once downloaded. Attempting to delete the malicious file will also trigger the kernel crash. The folks at Tetrane used this bug as an opportunity to show off their tools, and <a href="https://blog.tetrane.com/2019/11/12/pe-parser-crash.html">do a deep dive</a> into the problem and Microsoft’s fix.</p>
      <h3>The Android Camera Vulnerability</h3>
      <p>Android uses activities and intents to launch apps, and it’s possible for one app to send an intent to launch another app’s activity. This functionality is useful for many scenarios, but can have unintended consequences, like <a href="https://arstechnica.com/information-technology/2019/11/google-samsung-fix-android-spying-flaw-other-makers-may-still-be-vulnerable/">one app being able to request the camera app take pictures or video</a>.</p>
      <p>Imagine you download an app that requests access to your file storage. That gives an app access to all your images, videos, etc. If you’re willing to take that risk, the problem linked above allows that malicious app to take pictures and video, and then access those files. This isn’t a particularly subtle attack: the device will obviously launch the camera app and make the normal shutter sounds as pictures are taken. The <a href="https://www.checkmarx.com/blog/how-attackers-could-hijack-your-android-camera">researchers at Checkmarx</a> who discovered the problem suggest that a clever attacker would wait till the proximity sensor was activated. Recording a video in that state would likely catch the audio of an ongoing call, as well as being harder for a user to notice, as most phones turn the screen off when the proximity sensor detects a nearby face.</p>
      <p>The ArsTechnica article includes an ADB command you can run to test whether your device has been fixed. Its unclear how many devices have received the updates, and its likely that some older devices never will.</p>
      <h3>Disney Plus and Account Theft</h3>
      <p>Disney has released their new streaming service, Disney+. It probably shouldn’t be a surprise that <a href="https://www.zdnet.com/article/thousands-of-hacked-disney-accounts-are-already-for-sale-on-hacking-forums/">a large number of accounts were compromised and sold almost immediately</a>. Many of the Disney+ accounts were pre-paid for two or three years, making them enticing targets.</p>
      <p>Disney has stated that they didn’t actually suffer a breach. It’s likely that the accounts were compromised through one of several different methods. Password re-use is the simplest. Another possibility is phishing and ads pointing to fake login pages. Or maybe users logged into an already compromised machine that captured their credentials. In any case, it’s been a bit of a rocky launch for Disney+, likely due in large part to the larger-than-expected number of signups.</p>
      <h3>Docker CP Escape</h3>
      <p>Docker has proven itself invaluable as a way to isolate processes on a server. Have a public facing service that you worry could get compromised? Throw it in a Docker container, and even if it gets compromised, the OS is safe… theoretically. Announced on Tuesday, <a href="https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/">CVE-2019-14271</a> allows an attacker to trap a Docker image and escape the container into the bare-metal OS.</p>
      <p>The central concept of the flaw revolves around administrative commands being run in a <code>chroot</code> environment. Quick refresher, <code>chroot</code> is a Unix command that changes the effective root folder that a command is run in. In many ways, <code>chroot</code> is one of the predecessors to modern Docker-style containerization. Need to fix a non-booting Linux system? <code>Chroot</code> lets you set up an environment where you can run commands on a working machine, but using the target root filesystem.</p>
      <p>The <code>docker cp</code> command uses <code>chroot</code> to run a helper binary inside a given docker container. The problem occurs when that binary loads the shared <code>libnss</code> library. It’s already running inside a <code>chroot</code>, so it loads the library from the docker container! An attacker could simply replace a container’s <code>libnss</code> library with a malicious version, and the next time <code>docker cp</code> is used to copy a file out of that container, the attacker’s code is running as root outside the container. Docker 19.03.1 fixes the issue, so make sure you’re up to date!</p>
    </article>
  </body>
</html>