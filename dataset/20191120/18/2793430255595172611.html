<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://habr.com/en/company/flashphoner/blog/476554/?utm_source=telegram&amp;utm_medium=social&amp;utm_campaign=glavnye-it-novosti-k-etomu-chasu.cloud"/>
    <meta property="og:site_name" content="Habr"/>
    <meta property="article:published_time" content="2019-11-20T18:39:05+00:00"/>
    <meta property="og:title" content="Cloud-based WebRTC streaming on DigitalOcean"/>
    <meta property="og:description" content="Popular cloud hosting DigitalOcean has recently launched its new marketplace selling preconfigured images that can help to quickly deploy an application..."/>
  </head>
  <body>
    <article>
      <h1>Cloud-based WebRTC streaming on DigitalOcean</h1>
      <address><time datetime="2019-11-20T18:39:05+00:00">20 Nov 2019, 18:39</time> by <a rel="author" href="https://habr.com/en/users/fpn/" target="_blank">fpn</a></address>
      <figure>
        <img src="https://habrastorage.org/webt/qu/k2/rk/quk2rkqml_odwigj2khcbkjsgaa.png"/>
      </figure>
      <p>Popular cloud hosting DigitalOcean has recently launched its new marketplace selling preconfigured images that can help to quickly deploy an application server. It’s much like AWS, but DO is for those already using this provider’s services. Let’s see how to deploy a simple server for WebRTC streaming with a DO account for a $10/month fee based on Flashphoner WebCallServer and how such a server can be of use.</p>
      <h3>Deployment</h3>
      <p>Enter the DO account, choose the Flashphoner WebCallServer image in Marketplace and press "Create Flashphoner Web Call Server Droplet".</p>
      <figure>
        <img src="https://habrastorage.org/webt/3l/_f/35/3l_f35kar7y9bm3thyu1hvynmbk.png"/>
      </figure>
      <p>Choose the server performance and the pricing plan. DO will automatically offer a mid-segment product, but we are interested in the minimum price.</p>
      <figure>
        <img src="https://habrastorage.org/webt/er/y4/ck/ery4ckt3mvppfgrv10ui5a9st9u.png"/>
      </figure>
      <p>Choose the datacenter location region, for example, Frankfurt.</p>
      <figure>
        <img src="https://habrastorage.org/webt/dt/sw/3g/dtsw3gy3cy76buk6p2dgtikr_oc.png"/>
      </figure>
      <p>Choose the authentication type, for example, one-time password.</p>
      <figure>
        <img src="https://habrastorage.org/webt/jm/vn/5g/jmvn5g5yy6m702li7ovvxluzu8a.png"/>
      </figure>
      <p>Specify the number of servers (we are interested in one server for now) and name the server. This name will be registered among other locations in /etc/hostname.</p>
      <p>Press "Create droplet"</p>
      <figure>
        <img src="https://habrastorage.org/webt/fm/q1/ql/fmq1qlgnbpz5bq7r8ncqiyr40sw.png"/>
      </figure>
      <p>As soon as the server is created, it will start automatically. Now we can connect to it through SSH, and modify the password if one-time password has been chosen as authentication method. A short description of Flashphoner WebCallServer with links to documentation will be displayed in the console.</p>
      <figure>
        <img src="https://habrastorage.org/webt/rm/h2/xc/rmh2xcmpcjs5tvut5aybhumulgi.png"/>
      </figure>
      <h3>"This Is a Test. Can You See Me?"</h3>
      <p>By the time Flashphoner WebCallServer is started, it is in full ready-to-work mode, a 30-day trial license is activated automatically. Web interface is used to test the key functions. We will just check the publication and WebRTC stream playback.</p>
      <p>Open in the browser the page https://droplet_ip:8444/admin/. The server is shipped with self-signed certificate by default; therefore we will need to confirm security exception. The certificates can be replaced later with your own. Enter the username and password (<i>demo</i> by default).</p>
      <figure>
        <img src="https://habrastorage.org/webt/-a/xu/qw/-axuqw0izvkcml9ycx4qev8dbam.png"/>
      </figure>
      <p>Choose the Two-Way Streaming example in the sidebar, press "Connect", then "Publish". To play the stream press "Play".</p>
      <figure>
        <img src="https://habrastorage.org/webt/gg/uu/vg/gguuvghawemad1ch60ka4voke0a.png"/>
      </figure>
      <h3>For a Handful of Dollars</h3>
      <p>What can a $10/month server do as hardware platform for WebRTC streaming? Let’s see what Digital Ocean offers in terms of processor</p>
      <pre>lscpu</pre>
      <figure>
        <img src="https://habrastorage.org/webt/gz/my/dw/gzmydw2rmby7xbf_jfefcegdj14.png"/>
      </figure>
      <p>and memory</p>
      <pre>free -h</pre>
      <figure>
        <img src="https://habrastorage.org/webt/0f/m8/fl/0fm8fllsykumuxadaai1zqlf-lk.png"/>
      </figure>
      <p>By running load tests on the server, we can see that the server performance capabilities are not so small.</p>
      <p>As an example, we are going to publish one stream sample and see how many users will be able to publish this stream simultaneously not exceeding 90% of the processor resources:</p>
      <table bordered="">
        <tr>
          <th>Resolution</th>
          <th>Bitrate, Kbps</th>
          <th>Number of publications</th>
          <th>Number of viewers</th>
        </tr>
        <tr>
          <td>360p</td>
          <td>1300</td>
          <td>1</td>
          <td>70</td>
        </tr>
        <tr>
          <td>480p</td>
          <td>1800</td>
          <td>1</td>
          <td>70</td>
        </tr>
        <tr>
          <td>720p</td>
          <td>3000</td>
          <td>1</td>
          <td>50</td>
        </tr>
      </table>
      <p>With several simultaneous publications the maximum number of processed streams remains the same; when 7 streams are published, up to 10 viewers are able to subscribe to each.</p>
      <p>Suppose we need to transcode the stream on the server in order to reduce the resolution or align the FPS. To do this, we are going to check the maximum number of publications:</p>
      <table bordered="">
        <tr>
          <th>Resolution</th>
          <th>Bitrate, Kbps</th>
          <th>Number of streams</th>
        </tr>
        <tr>
          <td>360p</td>
          <td>1300</td>
          <td>5</td>
        </tr>
        <tr>
          <td>480p</td>
          <td>1800</td>
          <td>3</td>
        </tr>
        <tr>
          <td>720p</td>
          <td>3000</td>
          <td>2</td>
        </tr>
      </table>
      <p>In this manner, the server with the lowest price on DO with the parameters 1 CPU core, 2 Gb RAM, 2 TB traffic is suitable not only for testing WebRTC streaming but also for small projects. For example, it is possible to</p>
      <ul>
        <li>deliver a stream via WebRTC from an IP camera in order to ensure basic in-house video surveillance;</li>
        <li>organize a webinar for a small company staff;</li>
        <li>deploy your own internet-radio (audio streams require less processor resources).</li>
      </ul>
      <p>Besides, this server can be viewed as reference platform for scaling estimation. This is what we will deal with further on.</p>
      <h3>"I Deserve More!"</h3>
      <p>For the most part, the rules are quite simple: there’s no such thing as too many cores as well as too much memory. Depending on the intended number of users, DO configuration recommendations will be the following:</p>
      <table bordered="">
        <tr>
          <th>Number of users</th>
          <th>vCPUs</th>
          <th>RAM, Gb</th>
          <th>Traffic, TB</th>
          <th>Use case</th>
        </tr>
        <tr>
          <td>up to 200</td>
          <td>4</td>
          <td>8</td>
          <td>5</td>
          <td>Video surveillance system</td>
        </tr>
        <tr>
          <td>up to 500</td>
          <td>8</td>
          <td>16</td>
          <td>6</td>
          <td>Webinars</td>
        </tr>
        <tr>
          <td>up to 1000</td>
          <td>16</td>
          <td>64</td>
          <td>9</td>
          <td>Video chat</td>
        </tr>
        <tr>
          <td>up to 2000</td>
          <td>20</td>
          <td>96</td>
          <td>10</td>
          <td>HD video streaming</td>
        </tr>
      </table>
      <p>If further increase in number of users is planned, we will need to deploy the CDN projecting 1 Edge server per 2000 users. Suppose we need to deliver an HD video, the intended number of viewers is 10000. In this case, 2 Origin servers for publishing and 5 Edge servers for viewing will be required.</p>
      <figure>
        <img src="https://habrastorage.org/webt/d2/ky/xw/d2kyxwehzmckmsc09bltxy5epes.png"/>
      </figure>
      <p>Setup example:</p>
      <ul>
        <li>Origin 1</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=origin1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin</pre>
      <ul>
        <li>Origin 2</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=origin2.flashponer.com<br/>cdn_point_of_entry=origin1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin</pre>
      <ul>
        <li>Edge 1 — Edge 5 (here we change only the server address in the <code>cdn_ip</code> parameter)</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=edge1.flashphoner.com<br/>cdn_point_of_entry=origin1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge</pre>
      <p>CDN can also be of use if the users are geographically dispersed. For example, our target audiences are based in Europe and America.</p>
      <figure>
        <img src="https://habrastorage.org/webt/gd/45/2b/gd452bd762x9ou7zie8svwpvi8c.png"/>
      </figure>
      <p>Setup example:</p>
      <ul>
        <li>Origin EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=origin_eu.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin<br/>cdn_groups=EU</pre>
      <ul>
        <li>Origin US</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=origin_us.flashponer.com<br/>cdn_point_of_entry=origin_eu.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin<br/>cdn_groups=US</pre>
      <ul>
        <li>Edge 1 EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=edge1_eu.flashphoner.com<br/>cdn_point_of_entry=origin_eu.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge<br/>cdn_groups=EU</pre>
      <ul>
        <li>Edge 1 US</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=edge1_us.flashphoner.com<br/>cdn_point_of_entry=origin_eu.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge<br/>cdn_groups=US</pre>
      <p>The bigger the number of viewers is, the more diverse the devices for playback and the channels to these devices are. To provide good broadcast quality to various devices, it will most likely be needed to transcode the video, which can be imposed on special Transcoder servers.</p>
      <figure>
        <img src="https://habrastorage.org/webt/da/wi/n1/dawin1lf1bz_cqnovovjmcg5tms.png"/>
      </figure>
      <p>Setup example:</p>
      <ul>
        <li>Origin</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=origin.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin<br/>cdn_groups=default</pre>
      <ul>
        <li>Transcoder EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=transcoder_eu.flashponer.com<br/>cdn_point_of_entry=origin.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=transcoder<br/>cdn_groups=EU</pre>
      <ul>
        <li>Edge 1 EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=edge1_eu.flashphoner.com<br/>cdn_point_of_entry=origin.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge<br/>cdn_groups=EU</pre>
      <p>As we have found during the test, the number of processor cores is essential for the purposes of transcoding. The most suitable configuration in CPU-optimized configuration line is the most expensive one — 32 vCPU, 64 Gb RAM. At the same time the prices for CPU configurations similar in quantity and with bigger memory in other lines can be significantly higher. Unfortunately, one does not get to save money on transcoders: as the video is encoded frame by frame, there has to be enough memory space for all the images and enough processors for processing all the streams.</p>
      <p>During CDN deployment, the simultaneous creation of several servers with the same configuration will come in useful. However, in the case of geographically dispersed CDN same-type Edge and Transcoder servers will need to be hosted in different data centers.</p>
      <h3>Conclusion</h3>
      <p>To conclude, we have deployed and tested a small server for low latency WebRTC video streaming on Digital Ocean and have found that a server with minimum configuration is a good fit not only for testing but also for small projects. We have obtained the scaling data depending on the intended number of viewers and have touched upon the subject of CDN deployment, which as such deserves to be discussed in a separate article. To be continued, please stay with us.</p>
      <h3>Related links</h3>
      <p><a href="https://flashphoner.com/web-call-server-on-digital-ocean-marketplace">Flashphoner WebCallServer image in DigitalOcean Marketplace</a> — image of Web Call Server in DigitalOcean.</p>
      <p><a href="https://flashphoner.com/cdn-for-low-latency-webrtc-streaming">CDN for low latency WebRTC streaming</a> — Web Call Server-based content delivery network.</p>
    </article>
  </body>
</html>