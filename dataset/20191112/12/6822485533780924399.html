<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://www.alef.ir/news/3980821099.html"/>
    <meta property="og:site_name" content="جامعه خبری تحلیلی الف"/>
    <meta property="article:published_time" content="2019-11-12T12:54:00+00:00"/>
    <meta property="og:title" content="حملات گسترده ‏DDoS‏ با سو استفاده از ‏MTProxy‏های ‏تلگرام ‏"/>
    <meta property="og:description" content="سرویس تلگرام در ۱۰ اردیبهشت ۱۳۹۷ به دستور یک بازپرس به‌شکل کامل مسدود شد. یکی از امکانات تلگرام استفاده از الگوریتم رمزنگاری غیرمتقارنی به نام MTProto در راستای رمزنگاری محتوا بود. بعدها تلگرام از سرویسی با نام MTProxy استفاده کرد تا بتواند به‌کمک این پروتکل با فیلترینگ ایران مقابله کند."/>
  </head>
  <body>
    <article>
      <h1>حملات گسترده ‏DDoS‏ با سو استفاده از ‏MTProxy‏های ‏تلگرام ‏</h1>
      <address>
        <time datetime="2019-11-12T12:54:00+00:00">12 Nov 2019, 12:54</time>
      </address>
      <p>سرویس تلگرام در ۱۰ اردیبهشت ۱۳۹۷ به دستور یک بازپرس به‌شکل کامل مسدود شد. یکی از امکانات تلگرام استفاده از الگوریتم رمزنگاری غیرمتقارنی به نام MTProto در راستای رمزنگاری محتوا بود. بعدها تلگرام از سرویسی با نام MTProxy استفاده کرد تا بتواند به‌کمک این پروتکل با فیلترینگ ایران مقابله کند.</p>
      <p>نفوذ بسیار بالای تلگرام در ایران باعث شد کاربران بی‌شماری علاوه‌بر استفاده از فیلترشکن‌ها به فکر استفاده از MTProxyهای رایگان بیفتند. افرادی که بی‌اطلاع از همه‌جا امروز تبدیل به بات‌نت‌های یک شبکه‌ی بزرگ خرابکاری اینترنتی شده‌اند.</p>
      <p>ابر آروان با تحلیل حملات گسترده‌‌ی روزهای گذشته به زیرساخت‌های خود یک نوع حمله‌ی کاملن توزیع‌شده‌ی جدید را تشخیص داد. این حملات تفاوت‌های اساسی با حملات پیشین داشتند:</p>
      <ul>
        <li>این حملات مستقیمن به آدرس IP و پورت ۸۰ سرورهای لبه‌ی ابر آروان ارسال شده بودند و اثری از دامنه‌ا‎ی خاص در درخواست‌های آن‌ها یافت نمی‌شد.</li>
        <li>ترافیک دریافتی کاملن تصادفی به نظر می‌رسید. حتا آنتروپی محاسبه شده روی اطلاعات درخواست‌های دریافتی تقریبن معادل ۴ بود.</li>
        <li>ترافیک دریافتی در لایه‌ی ۷ بود. اما از هیچ‌یک از پروتکل‌های معروف این لایه مانند HTTP، HTTPS، FTP و… پیروی نمی‌کرد.</li>
        <li>حمله کاملن داخلی بود و IPهای حمله‌کننده، در داخل کشور قرار داشتند.</li>
      </ul>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTpoto-111.jpg"/>
      </figure>
      <p>تصویر ۱: درخواست‌های عادی به سرورهای لبه‌ی ابر آروان</p>
      <p>حجم بالای این حملات می‌توانست بسیاری از وب‌سایت‌ها و سامانه‌های آنلاین را دچار اختلال کند، اما برای ساختار توزیع‌شده‎ و سامانه‌های جلوگیری از حملات DDoS ابر آروان مقابله با این حملات کار سختی به نظر نمی‌رسید، اما تحلیل این حملات به آسانی همیشه نبود.</p>
      <p>نه از داده‌ها‎ی ارسالی می‌توانستیم سرنخی به‌دست آوریم، نه نشانی‌های درخواست‌های ارسالی الگوی مشترکی داشتند که بتوانیم از آن‌ها استفاده کنیم.</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTpoto-2121.jpg"/>
      </figure>
      <p>تصویر ۲: درخواست‌های ارسالی به سرورهای لبه‌ی ابر آروان در حمله</p>
      <blockquote>این حمله در روز سه‌شنبه ۱۴ آبان ساعت ۲۳:۳۶ دقیقه شروع و در روز یکشنبه ۱۹ آبان ساعت ۲۳:۴۶ دقیقه به پایان رسید. اوج این حملات روز چهارشنبه بود که تعداد درخواست‌های ارسالی به سمت سرورهای ابر آروان به حدود ۱۰۰ هزار درخواست در ثانیه رسید. اگرچه این حملات در مقابل حملات گسترده‌ای که در ابر آروان با آن مقابله می‌شود از شدت بسیار بالایی برخوردار نبودند اما همین حملات، امکان از دسترس خارج کردن بیش‌تر وب‌سایت‌های کشور را دارند. تفاوت مهم دیگر، وجود منشا داخلی این حملات بود که باعث پررنگ‌تر شدن آن می‌شود.</blockquote>
      <h3>کشف منشا</h3>
      <p>برای یافتن منشا حملات، فعالیت‌های زیادی انجام شد که بسیاری از آن‌ها شکست خوردند. اما در ساعات انتهایی روز شنبه، به حدسی هوشمندانه دست یافتیم؛ شاید ترافیک برای سرویس MTProxy نرم‎افزار تلگرام باشد!</p>
      <p>چند نکته در ترافیک نمونه‌گیری شده وجود داشت که این حدس را تقویت می‎کرد:</p>
      <ul>
        <li>ترافیک سرویس MTProxy رمزنگاری شده است و ترافیک رمز شده معمولن رفتاری مانند ترافیک تصادفی دارد. هم‌چنین در پروتکل MTProto این درهم‌ریختگی تصادفی، تشدید نیز می‌شود.</li>
        <li>متاسفانه با فیلتر شدن تلگرام استفاده از سرویس MTProxy برای دور زدن فیلترینگ، روی این سرویس بسیار شایع شده است که با توزیع‌شدگی شدید این حمله تطابق داشت.</li>
        <li>ارسال و استفاده از سرویس‌های رایگان MTProxy در کانال‌های تلگرام امری شایع و ساده است. به‌راحتی می‎توان با تغییر نشانی IP یکی از این سرورها به نشانی ابر آروان، ترافیک مشابه ایجاد کرد.</li>
        <li>به‌دلیل ساختار استفاده از سرویس MTProxy، چند نشانی به‌عنوان سرور در اختیار نرم‌افزار قرار می‌گیرد که به‌وسیله‌ی تلگرام بررسی می‌شوند. این بررسی خودکار می‌تواند منجر به ایجاد ترافیک بدون اطلاع کاربر شود.</li>
        <li>یک دامین پروکسی می‌تواند دارای چندین نشانی IP باشد و تلگرام به تمام این IPها درخواست را ارسال می‌کند. اگر یکی از این IPها برای حمله استفاده شود و باقی آن‌ها درست کار کند، کاربر تنها با کندی سرویس پروکسی مواجه و متوجه قطع سرویس نمی‌شود.</li>
      </ul>
      <p>با شبیه‌سازی سناریوی احتمالی، حدس سرویس MTProxy تقویت شد. ترافیک ایجاد شده به ترافیک دریافتی شباهت زیادی داشت. موضوعی که با بررسی ترافیک نمونه‌گیری از درستی آن اطمینان پیدا کردیم.</p>
      <p>در زیر تصویر یکی از استریم‌های TCP کپچر شده در نرم‎افزار Wireshark آمده که به‌شکل hexdump آن را مشاهده می‌کنید.</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTpoto-222.jpg"/>
      </figure>
      <p>سپس قسمت پیام ارسالی را کپی و براساس پروتکل MTProto جداسازی کردیم که در شکل زیر آن را مشاهده می‌کنید.</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTpoto-333.jpg"/>
      </figure>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTpoto-4.jpg"/>
      </figure>
      <p>بر اساس پروتکل MTProto، قسمت کلید اولیه از پیام جدا شده را با ترکیبی از secret سرویس MTProxy ساختیم. اما مقدار secret برای ما قابل ارزیابی نبود. با یک حدس هوشمندانه توانستیم مقدار درست secret را ارزیابی کنیم. این مقدار 0x00000000000000000000000000000000  بود! با استفاده از این مقدار توانستیم هش مورد نظر را محاسبه و به عنوان کلید رمزگشایی از آن استفاده کنیم.</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTProto-6.jpg"/>
      </figure>
      <p> با استفاده از کلید به‌دست آمده و I.V با الگوریتم AES-256bit در مُد CTR، توانستیم کل پیام را رمزگشایی کنیم. یکی از امضاهای پروتکل MTProto داشتن مقادیر 0xefefefef یا 0xeeeeeeee و یا 0xdddddddd در بایت ۵۷ام است که در ترافیک نمونه‎گیری شده، مشاهده می‎شود.</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTProto-67.jpg"/>
      </figure>
      <p>تیم امنیت ابر آروان پس از مطمین شدن از جنس ترافیک، به کانال‌های تلگرامی ارایه دهنده‌ی سرویس MTProxy مراجعه کرد. برخی از سرورهای ارایه شده در این کانال‌ها، به نشانی IP ابرآروان resolve می‌شدند که تعدادی از این نشانی‌ها در فهرست زیر آمده است:</p>
      <p>Atom.ChMTP.Info</p>
      <p>walking.firewall-gateway.com</p>
      <p>ToKhobi.MyFirewall.org</p>
      <figure>
        <img src="https://circle.arvancloud.com/wp-content/uploads/2019/11/MTProto-8.jpg"/>
      </figure>
      <h3>سخن پایانی</h3>
      <p>در این یادداشت به رخدادی اشاره کردیم که به احتمال زیاد حمله‌ای است که در نوع خود تاکنون گزارش نشده است. این مشکل از فیلتر شدن تلگرام شروع می‌شود. نبود نگاه چند جانبه نسبت به فناوری‌های روز باعث حذف یک پیام‌رسان با میلیون‌ها مخاطب شد، موضوعی که در مقاطع مختلف با تهدیدات متفاوتی کشور را مواجه کرده است.</p>
      <p>رواج بیش‌ از اندازه نسخه‌های غیر اصل از تلگرام که متهم به سو استفاده از دستگاه‌های شخصی کاربران ایرانی بودند یکی از این موارد، و اکنون نیز استفاده از MTProxy رایگان، و ترویج آن تهدید بزرگ دیگری را در برابر کاربران ایرانی قرار داده است.</p>
      <p>در حال حاضر ابر آروان هشدار جدی می‌دهد که اگر تصمیمات سختی اتخاذ نشود، مدیران کانال‌های تلگرامی که اقدام به ترویج MTProxyهای رایگان می‌کنند، دو قدرت بسیار مهم در اختیار خواهند داشت:</p>
      <ul>
        <li>سو استفاده از کاربران بی‌شمار ایرانی برای DDoS کردن وب‌سایت‌های یا سامانه‌های حیاتی کشور</li>
        <li>گمراه کردن دستگاه‌های حاکم بر فضای سایبری و قربانی کردن سرورهای بی‌گناه با ارسال ترافیک MTProto به این سرورها</li>
      </ul>
    </article>
  </body>
</html>