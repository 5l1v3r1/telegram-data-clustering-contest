<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://habr.com/en/company/zadarma/blog/474178/"/>
    <meta property="og:site_name" content="Habr"/>
    <meta property="article:published_time" content="2019-11-12T12:04:41+00:00"/>
    <meta property="og:title" content="IVR on Webhook"/>
    <meta property="og:description" content="An online chatbot is a recent trend on the market. But how to interact with the clients that are offline? A significant percentage of people prefer to..."/>
  </head>
  <body>
    <article>
      <h1>IVR on Webhook</h1>
      <address><time datetime="2019-11-12T12:04:41+00:00">12 Nov 2019, 12:04</time> by <a rel="author" href="https://habr.com/en/users/elena_zz/" target="_blank">elena_zz</a></address>
      <figure>
        <img src="https://habrastorage.org/webt/6i/wc/yt/6iwcytdcaivt0kpvrob20iahmsm.png"/>
      </figure>
      <p>An online chatbot is a recent trend on the market. But how to interact with the clients that are offline? A significant percentage of people prefer to interact over the phone. And the business needs either a large staff of operators or a voice communication automating solution. We are offering a solution to reduce workload and costs (and will barely affect your developers’ busyness).<br/><br/>How to rapidly and easily program any voice menu, auto-informant, robot-secretary with an attached client database?<br/><br/>Spoiler alert: everything is done by implementing webhooks and we are using PHP example.<br/><br/><b>What and why?</b><br/><br/>For instance, you have a delivery service or an online store with its own logistics in place. Some customers are calling to see what’s with their packages and that can be easily automated. The same goes for cab geolocation, some data collection, or any individual information that can be reported to the client without wasting human power. <br/><br/>It can be easily automated, we’ll provide an example below. Oh, and it can be done completely for free.<br/><br/><b>Why not your own asterisk?</b><br/><br/>Of course, it can all be done with Asterisk, but aside from the developer, you will also need an administrator, who is also familiar with voice communication security (as they frequently get hacked). <br/>So we will discuss the simplest way to solve the task – with webhooks.<br/><br/><b>List of methods</b><br/><br/>You will only need two new methods for the job, but each of them provides you with a lot of possibilities, and most importantly – unlimited cycles. With the help of these cycles, you can get a multilevel voice menu and an informant for any subject.<br/><br/><b>Main methods:</b></p>
      <ul>
        <li>NOTIFY_START — the beginning of an incoming call in PBX</li>
        <li>NOTIFY_IVR — callers’ response to a given action</li>
      </ul>
      <p>The detailed method description is available to copy-paste in <a href="https://zadarma.com/en/support/api/#webhook">API description</a>.<br/><br/>For NOTIFY_START and NOTIFY_IVR requests you can change scenarios during the call by responding with one of the options:</p>
      <figure>
        <img src="https://habrastorage.org/webt/o-/qb/2j/o-qb2j_sbansavtyv9ozmcepotw.png"/>
      </figure>
      <figure>
        <img src="https://habrastorage.org/webt/km/jz/g9/kmjzg91272jweekf2s1mwv6g-re.png"/>
      </figure>
      <figure>
        <img src="https://habrastorage.org/webt/er/u4/kf/eru4kf3bhtepzadbkqjgwsk8oic.png"/>
      </figure>
      <figure>
        <img src="https://habrastorage.org/webt/_y/fg/7a/_yfg7akgztm3m-9nxqcqpowpcvo.png"/>
      </figure>
      <figure>
        <img src="https://habrastorage.org/webt/da/xh/d-/daxhd-p3c1f2ewcljo4xg-o85qu.png"/>
      </figure>
      <figure>
        <img src="https://habrastorage.org/webt/nj/rd/o3/njrdo3kqwruuctzcogbjdrw3vh0.png"/>
      </figure>
      <p>So, a client calls and hears the greeting, then dials a certain number (for example, a tracking code), we send a notification with the entered digits, the script checks with the database and sends the response to us. The response can contain a voice file id or a standard voice reply. <br/><br/>We have a standard number playing system, so you don’t have to record a response ahead; meaning, the appropriate notification is chosen from the database and is played as a number by a robot. Or you can create up to a hundred default voice messages and use them to reply to clients (e.g. “Your delivery is at the warehouse”, “You can receive your package every day between 9 a.m. and 10 p.m.).<br/><br/><b>The implementation minimum</b><br/><br/>For the responder to answer you need the minimum of a phone number and a PBX. You should also upload or enter the possible responses.<br/><br/><b>Set up</b></p>
      <figure>
        <img src="https://habrastorage.org/webt/nr/wc/u_/nrwcu_blznq1tjzmncdz3i4s_fy.png"/>
      </figure>
      <ol>
        <li><a href="https://zadarma.com/en/services/pbx/">Free PBX</a> for this task can be set in three clicks (choose the number of employees and the voice menu can be set later)</li>
        <li>Phone <a href="https://zadarma.com/en/tariffs/numbers/">numbers</a> for PBX can be connected from 100 countries around the world. The number connects automatically after ID verification is complete (if it is required for the country of your choice). You can also connect one of your own number for free</li>
        <li>To set the voice menus, go to the “Incoming calls and IVR” page and choose an option that suits you best. Or you can upload your files, or type in a text and the robot will read it automatically. There are 16 languages available with several voices for each one (14 voices in English). You can save up to 100 greetings in your personal account.</li>
      </ol>
      <figure>
        <img src="https://habrastorage.org/webt/fi/om/f_/fiomf_rhb6i5kneddqae5pxj_uy.png"/>
      </figure>
      <p><b>PHP example</b><br/><br/>To demonstrate different options, we have created 4 examples of IVR performance on PHP.</p>
      <ol>
        <li>The system tells last 3 digits from CallerID (example of work with info about numbers and pronouncing digits)</li>
        <li>The user enters their date of birth in DTMF and the system tells how many days left until the birthday (working with DTMF and pronouncing digits)</li>
        <li>Endless multilevel menu: the user can enter digits and get to the next/previous menu (example of how with a simple cycle you can create any number of voice menus)</li>
        <li>Example of authorization to receive the balance status (useful for many life situations)</li>
      </ol>
      <p>The first three examples are available on <a href="https://github.com/zadarma/user-api-v1/blob/master/examples/webhook.php">GitHub</a>. There you have all the required elements, you just need to insert the files with the filling (that have to be to prior uploaded to or read in PBX).<br/><br/><b>Task 4</b>: the caller hears the greeting and is asked to enter the identification number, after entering the system tells the balance, says goodbye using a popular phrase from the list and ends the call. <br/><br/>Here’s an example of code for the described task.<br/><b>PHP code</b></p>
      <pre>$request = new Request();<br/>$notify = self::getEvent([AbstractNotify::EVENT_START, AbstractNotify::EVENT_IVR]);<br/>if (!$notify) {<br/>    return;<br/>}<br/>switch ($notify-&gt;event){<br/>    case AbstractNotify::EVENT_START:<br/>        $request<br/>            -&gt;setIvrPlay(self::INFO_FILE_ID)<br/>            -&gt;setWaitDtmf(TIMEOUT , ATTEMPTS, MAXDIGITS, DTMF_NAME, DEFAULT_BEHAVIOUR);<br/>        break;<br/><br/>    case AbstractNotify::EVENT_IVR:<br/>        if (!empty($notify-&gt;wait_dtmf-&gt;digits)) {<br/>            $balance = getBalance($notify-&gt;wait_dtmf-&gt;digits);<br/>            $request-&gt;setIvrSayNumber($balance, 'en');<br/>        } elseif (!empty($notify-&gt;ivr_saynumber)) {<br/>            $request-&gt;setIvrSayPopular(POPULAR_PHRASE_NUM, 'en');<br/>        } else {<br/>            $request-&gt;setHangup();<br/>        }<br/>}<br/>$request-&gt;send();</pre>
      <p>We looking to further expand our method features and collecting feedback in the comments below. We also have other webhook methods and API available, you can see the full list <a href="https://zadarma.com/en/support/api/">on the website</a>.</p>
    </article>
  </body>
</html>