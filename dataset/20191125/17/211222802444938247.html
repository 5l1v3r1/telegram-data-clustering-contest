<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://xakep.ru/2019/11/25/byepg/"/>
    <meta property="og:site_name" content="«Хакер»"/>
    <meta property="article:published_time" content="2019-11-25T17:30:32+00:00"/>
    <meta property="og:title" content="Эксперт обошел защиту Microsoft Kernel Patch Protection"/>
    <meta property="og:description" content="Исследователь представил PoC-эксплоит для обхода защитной функции Microsoft Kernel Patch Protection (KPP), более известной под названием PatchGuard."/>
  </head>
  <body>
    <article>
      <h1>Эксперт обошел защиту Microsoft Kernel Patch Protection</h1>
      <address><time datetime="2019-11-25T17:30:32+00:00">25 Nov 2019, 17:30</time> by <a rel="author" href="https://xakep.ru/" target="_blank">Мария Нефёдова</a></address>
      <p>Турецкий ИБ-специалист представил PoC-эксплоит для обхода функции Microsoft Kernel Patch Protection (KPP), более известной под названием PatchGuard. Его инструмент получил имя <a href="https://blog.can.ac/2019/10/19/byepg-defeating-patchguard-using-exception-hooking/">ByePg</a>, и эксплоит касается HalPrivateDispatchTable, чтобы в итоге позволяет вредоносному приложению вмешиваться в работу ядра.</p>
      <p>Функция Microsoft Kernel Patch Protection (KPP), более известная под названием PatchGuard, была представлена ​​в далеком 2005 году в Windows XP. Она доступна только для 64-разрядных версий Windows, и ее роль заключается в том, чтобы приложения не могли вмешиваться в работу ядра. В сущности, до выхода PatchGuard многие приложения позволяли себе модифицировать ядро ​​Windows для облегчения своей работы или получения доступа к различным функциям. Антивирусное ПО, драйверы, игровые читы и малварь часто «патчили» ядро с совершенно разными целями. В частности, подобные техники очень любили разработчики руткитов, ведь это позволяло им внедрить малварь на уровне ОС, предоставив ей беспрепятственный доступ к машине жертвы.</p>
      <p>Со временем PatchGuard отошел на второй план, на фоне многочисленных защитных механизмов Windows, но ИБ-специалисты продолжали использовать эту функциональность и искать новые способы обхода защиты. Так, в 2015 году, после релиза Windows 10 специалисты CyberArk  представили обход PatchGuard названный <a href="https://www.cyberark.com/threat-research-blog/ghosthook-bypassing-patchguard-processor-trace-based-hooking/">GhostHook</a>. Он использовал функцию Intel Processor Trace (PT), чтобы обойти PatchGuard и внеси исправления в ядро. Затем, летом текущего года, эксперт Riot Games нашел еще один способ обхода защиты, который был назван <a href="https://github.com/everdox/InfinityHook">InfinityHook</a> и использовал для работы NtTraceEvent API.</p>
      <p>Теперь же был создан ByePg, использующий для обхода защиты HalPrivateDispatchTable. Разработчик эксплоита отмечает, что потенциал его использования ограничен исключительно креативностью того, кто его применяет. Хуже того, ByePG помогает обойти не только PatchGuard, но и Hypervisor-Protected Code Integrity (HVCI), функцию, которую Microsoft использует для занесения «плохих» драйверов в черный список.</p>
      <p>Все три перечисленные метода обхода защитных функций стали достоянием общественности, так как Microsoft не спешит выпускать исправления и закрывать эти бреши (хотя заплатки для GhostHook  и InfinityHook в конечном счете все же были созданы). Дело в том, что для работы таким эксплоитам нужны права администратора, из-за чего в компании отказываются классифицировать их как проблемы безопасности.</p>
      <p>Разработчики Microsoft уверены, что если злоумышленник получил доступ к локальной системе с правами администратора, далее он может выполнять любые операции. Вопрос в том, что к PatchGuard эта «отговорка» вряд ли применима, ведь защитный механизм был предназначен именно для защиты ядра от процессов с высокими привилегиями, таких как драйверы или антивирусное ПО.</p>
      <p>Также дело осложняется тем, что проблемы в PatchGuard не подпадают пол программу bug bounty, и специалисты, обнаруживавшие такие баги, не могут рассчитывать на денежное вознаграждение. Сотрудник Microsoft, пожелавший остаться неизвестным, рассказал журналистам издания <a href="https://www.zdnet.com/article/new-bypass-disclosed-in-microsoft-patchguard-kpp/">ZDNet</a>, что проблемы PatchGuard компанией вовсе не игнорируются, и исправления для них выходят, пусть и немного медленнее других патчей. Однако исследователи, зная, что не получат денег, а обнаруженным уязвимостям не будут присвоены идентификаторы CVE, предпочитают публиковать результаты свои изысканий в открытом доступе и в целом занимаются изучением подобных проблем весьма неохотно.</p>
    </article>
  </body>
</html>