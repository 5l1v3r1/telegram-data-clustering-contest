<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://habr.com/en/company/flashphoner/blog/477304/"/>
    <meta property="og:site_name" content="Habr"/>
    <meta property="article:published_time" content="2019-11-25T09:19:44+00:00"/>
    <meta property="og:title" content="Dynamic CDN for Low Latency WebRTC Streaming"/>
    <meta property="og:description" content="Having analyzed earlier the capacity of standard server configurations in Digital Ocean in terms of WebRTC streaming, we have noticed that one server can cover..."/>
  </head>
  <body>
    <article>
      <h1>Dynamic CDN for Low Latency WebRTC Streaming</h1>
      <address><time datetime="2019-11-25T09:19:44+00:00">25 Nov 2019, 09:19</time> by <a rel="author" href="https://habr.com/en/users/fpn/" target="_blank">fpn</a></address>
      <figure>
        <img src="https://habrastorage.org/webt/qp/yd/gy/qpydgy2jfifixw87t9seev0eb7o.jpeg"/>
      </figure>
      <p>Having analyzed earlier the capacity of standard <a href="https://habr.com/en/company/flashphoner/blog/476554/">server configurations in Digital Ocean</a> in terms of WebRTC streaming, we have noticed that one server can cover up to 2000 viewers. In real life, cases when one server is insufficient are not uncommon.</p>
      <p>Assume gambling amateurs in Germany are watching real-time horse races in Australia. Given that horse races are not only a sports game but also imply big gains on condition that field bets are made at the right time, the video has to be delivered with lowest possible latency.</p>
      <p>Another example: A global corporation, one of FCMG market leaders with subsidiaries in Europe, Russia and Southeast Asia, is organizing sales manager training webinars with live streaming from the headquarters in the Mediterranean. The viewers must be able to see and hear the presenter in real time.</p>
      <p>These examples put forward the same requirement: deliver low latency media streams to a great number of viewers. This will require deploying a content delivery network — CDN.</p>
      <p>It should be noted that the conventional stream delivery technology using HLS is not well-suited as it can add up to 30 second delays, which are critical for a real-time show. Imagine that the horses have already finished, the results have been published on the website, while the fans are still watching the end of the race. WebRTC technology is free from this disadvantage and can guarantee less than 1 second delays, which is possible even across continents thanks to modern communication channels.</p>
      <p>To begin with, we will see how to deploy the simplest CDN for delivering WebRTC streams and how to scale it afterwards.</p>
      <h3>CDN principles</h3>
      <p>A server in CDN can play one of the following roles:</p>
      <ul>
        <li>Origin is the server built for publishing media streams. It shares streams to other servers as well as users.</li>
        <li>Transcoder is the server dedicated for transcoding streams. It pulls streams from the Origin server and passes transcoded streams to Edge. We will look at this role in the following part.</li>
        <li>Edge is the server designed for sharing streams to users. It pulls streams from Origin or Transcoder servers and does not pass them to other CDN servers.</li>
      </ul>
      <p>Origin server allows publishing WebRTC and RTMP streams or capturing streams from other sources via RTMP, RTSP or other available methods.</p>
      <p>Users can play streams from Edge servers via WebRTC, RTMP, RTSP, HLS.</p>
      <p>In order to minimize latency, it is desirable to transmit streams among CDN servers using WebRTC.</p>
      <p>Static CDN is entirely described at the configuration stage. In fact, the setup of a static CDN is similar to the setup of a load balancer: all the receivers are listed in the settings of the stream source server.</p>
      <p>For example, we have one Origin server in Frankfurt, one Edge in New York and one in Singapore</p>
      <figure>
        <img src="https://habrastorage.org/webt/so/gg/1w/sogg1wq1m_67p9waxgdyjbtix4y.png"/>
      </figure>
      <p>In this case Origin will be set up more or less like this:</p>
      <pre>&lt;loadbalancer mode="roundrobin" stream_distribution="webrtc"&gt;<br/>        &lt;node id="1"&gt;<br/>                &lt;ip&gt;edge1.thestaticcdn.com&lt;/ip&gt;<br/>                &lt;wss&gt;443&lt;/wss&gt;<br/>        &lt;/node&gt;<br/>        &lt;node id="2"&gt;<br/>                &lt;ip&gt;edge2.thestaticcdn.com&lt;/ip&gt;<br/>                &lt;wss&gt;443&lt;/wss&gt;<br/>        &lt;/node&gt;<br/>&lt;/loadbalancer&gt;</pre>
      <p>Here comes the first issue with the static CDN: in order to include into this kind of CDN a new Edge server or exclude a server out of a CDN, it is required to modify the settings and restart all Origin servers.</p>
      <p>The streams published on Origin are broadcast to all Edge servers listed in the settings. The decision on which Edge server the user will connect to is also taken on Origin server. Here comes the second issue: if there are few or no viewers — for example, in Singapore it’s early evening while in New York it’s the middle of the night — the streams will be broadcast to Edge 1 anyway. The traffic is being wasted to no purpose, and it is not free of charge.</p>
      <p>These two issues can be solved using Dynamic CDN.</p>
      <p>Now, we want to set up the CDN without restarting all Origin servers and do not want to transmit streams to Edge servers with no users connected. In this case, there is no need to keep the whole list of CDN servers somewhere in the settings. Each server must create such a list independently. In order to do this, it must know the current status of the other servers at any specific time.</p>
      <p>Ideally, specifying the entry point — the server which begins the CDN — in the settings should be enough. During startup each server must send a request to this entry point and get in response the list of CDN nodes and published streams. If the entry point cannot be accessed, the server must wait for messages from other servers.<br/>The server must communicate any changes in its status to other servers in the CDN.</p>
      <h3>The simplest CDN: in the centre of Europe</h3>
      <p>Now we are going to try setting up and starting a dynamic CDN. Assume first we need to deliver media streams to viewers in Europe covering up to 5000 users. Suppose the stream source is also located in Europe</p>
      <figure>
        <img src="https://habrastorage.org/webt/xo/oi/rx/xooirxhid75yiqsfuff8sdu5xge.png"/>
      </figure>
      <p>We are going to deploy three servers in a data center based in Europe. We will use Flashphoner WebCallServer (WebRTC stream video server) instances as CDN assembly components</p>
      <figure>
        <img src="https://habrastorage.org/webt/ts/de/4x/tsde4xzznh96b-15pb7pephsqlc.png"/>
      </figure>
      <p>Setup:</p>
      <ul>
        <li>Origin EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin</pre>
      <ul>
        <li>Edge 1 EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=e-eu1.flashphoner.com<br/>cdn_point_of_entry=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge</pre>
      <ul>
        <li>Edge 2 EU</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=e-eu2.flashphoner.com<br/>cdn_point_of_entry=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge</pre>
      <p>Message exchange between dynamic CDN nodes is implemented via Websocket, and Secure Websocket is certainly also supported.</p>
      <p>The streams inside CDN are broadcast via WebRTC. Usually UDP is used as transport, but if it is necessary to ensure good streaming quality with the channel between the servers being not so good, it is possible to switch to TCP. Unfortunately, in this case, the latency increases.<br/>Restart the servers, open the Two Way Streaming example on the <code>o-eu1</code> server, publish the cyclical 10 minutes to 0 countdown timer video</p>
      <figure>
        <img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"/>
      </figure>
      <p>Open the Player example on the <code>e-eu1</code> server, play the stream</p>
      <figure>
        <img src="https://habrastorage.org/webt/fc/3p/st/fc3pst40kkeh0gh0dunrcktlksg.png"/>
      </figure>
      <p>and do the same thing on <code>e-eu2</code></p>
      <figure>
        <img src="https://habrastorage.org/webt/el/j5/ew/elj5ew8cqvaxpvmbmr14wwl1dvu.png"/>
      </figure>
      <p>The CDN is working! As you can see on the screenshots, the timing in the video coincides to the second both on the publishing part and on the viewing part thanks to WebRTC and good channels.</p>
      <h3>And beyond we go: connecting America</h3>
      <p>Now we are going to deliver streams to viewers on the American continent keeping in mind as well the publishing</p>
      <figure>
        <img src="https://habrastorage.org/webt/y6/8r/ig/y68rigg5xu5uq32qmvrb2_6yexq.png"/>
      </figure>
      <p>We will deploy three servers in an American data center without shutting the European part of the CDN down</p>
      <figure>
        <img src="https://habrastorage.org/webt/t5/q8/vh/t5q8vh5mlwgvixiq_l-zdin6bje.png"/>
      </figure>
      <p>Setup:</p>
      <ul>
        <li>Origin US</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=o-us1.flashponer.com<br/>cdn_point_of_entry=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=origin</pre>
      <ul>
        <li>Edge 1 US</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=e-us1.flashphoner.com<br/>cdn_point_of_entry=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge</pre>
      <ul>
        <li>Edge 2 US</li>
      </ul>
      <pre>cdn_enabled=true<br/>cdn_ip=e-us2.flashphoner.com<br/>cdn_point_of_entry=o-eu1.flashponer.com<br/>cdn_nodes_resolve_ip=false<br/>cdn_role=edge</pre>
      <p>Restart the American servers, check the publishing</p>
      <figure>
        <img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"/>
      </figure>
      <p>and the playback</p>
      <figure>
        <img src="https://habrastorage.org/webt/4i/ur/_s/4iur_sn57za5_ypd9pssupfg8rm.png"/>
      </figure>
      <p>Note that the European segment keeps working. We are going to check if the American users will be able to see the stream published from Europe. Publishing the <code>test_eu</code> stream on the <code>o-eu1</code> server</p>
      <figure>
        <img src="https://habrastorage.org/webt/yp/dk/0o/ypdk0o9fnrje0kbmtx7-duhrkuo.png"/>
      </figure>
      <p>and playing it on <code>e-us1</code></p>
      <figure>
        <img src="https://habrastorage.org/webt/ld/6n/u3/ld6nu3rzicqjotfzz88goggo1lk.png"/>
      </figure>
      <p>And this is also working! As for the latency, the screenshots demonstrate again the synchrony of the timer in the video on the publishing part and on the viewing part to the second.</p>
      <p>Note that playing on an Origin server the streams published on another Origin server is not possible by default, but if necessarily needed, this can be set up accordingly.</p>
      <pre>cdn_origin_to_origin_route_propagation=true</pre>
      <h3>To be continued</h3>
      <p>In summary, we have deployed a simple CDN and then have successfully scaled it to two continents publishing and playing low latency WebRTC streams. For this purpose, we did not modify the stream parameters at playback, which is quite often needed in real life: all the viewers have different channels, and in order to maintain the streaming quality it is needed, for example, to reduce the resolution or the bitrate. We will deal with this in the following part...</p>
      <h3>Related links</h3>
      <p><a href="https://flashphoner.com/web-call-server-on-digital-ocean-marketplace">Flashphoner WebCallServer image in DigitalOcean Marketplace</a> — image of Web Call Server in DigitalOcean.</p>
      <p><a href="https://flashphoner.com/cdn-for-low-latency-webrtc-streaming">CDN for low latency WebRTC streaming</a> — Web Call Server-based content delivery network.</p>
      <related>
        <h4>Similar posts</h4>
        <a href="https://habr.com/en/post/476554/"/>
      </related>
    </article>
  </body>
</html>