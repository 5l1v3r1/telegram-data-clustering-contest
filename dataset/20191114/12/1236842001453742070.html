<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://dtf.ru/gamedev/81487-kak-v-dying-light-ustroen-parkur"/>
    <meta property="og:site_name" content="DTF"/>
    <meta property="article:published_time" content="2019-11-14T12:07:24+00:00"/>
    <meta property="og:title" content="Как в Dying Light устроен паркур"/>
    <meta property="og:description" content="Секреты свободы перемещения от первого лица."/>
  </head>
  <body>
    <article>
      <h1>Как в Dying Light устроен паркур</h1>
      <address><time datetime="2019-11-14T12:07:24+00:00">14 Nov 2019, 12:07</time> by <a rel="author">Artyom Kaleev</a></address>
      <p>Секреты свободы перемещения от первого лица.</p>
      <p>Ядро геймплея Dying Light основано на паркуре в открытом мире — игрок может попасть куда угодно и при помощи самых разных маршрутов. Мы выбрали главное из <a href="https://youtu.be/uikbLyi-cug">лекции</a> разработчика Бартоша Кулона с GDC 2018 о том, как в игре устроена система передвижения.</p>
      <figure>
        <img src="https://leonardo.osnova.io/e29740a3-0882-402c-a58f-e480d35a95ab/"/>
      </figure>
      <h3>Основы дизайна перемещения</h3>
      <p>Как дать понять, что игрок может куда-то залезть? Для этого он должен различать три вектора: начало и конец платформы, а также направление вперёд, по которому можно пройти дальше.</p>
      <figure>
        <img src="https://leonardo.osnova.io/2491e755-36c6-11b8-818b-6da046f2680d/"/>
      </figure>
      <p>Исходя из этого принципа, поначалу в Techland все конструкции для паркура хотели расставить вручную — чтобы у разработчиков был контроль над всеми маршрутами, по которым может пойти игрок. Однако на ранних тестах это вылилось в то, что на прототипе игровой карты уже существовало 50 тысяч платформ, и их число продолжало расти.</p>
      <p>Так как изначально Dying Light разрабатывалась под прошлое поколение консолей, от такого подхода пришлось отказаться — память устройств тех лет была невелика и быстро забивалась. Поэтому в Techland пошли по другому пути: вместо того, чтобы расставлять платформы вручную, они определялись игрой автоматически в реальном времени.</p>
      <p>От положения игрока прокладывается некое количество лучей, которое сканирует окружение и проверяет, где он сможет залезть. Когда происходит совпадение по нужной высоте, по длине луча игра удостоверяется, что на конструкции хватает места для персонажа. Если все нужные условия соблюдены, платформа для паркура «активируется».</p>
      <figure>
        <img src="https://leonardo.osnova.io/6d493986-8f49-85d4-2862-476712e1cedd/"/>
      </figure>
      <p>Благодаря этому в Techland добились «потрясающей свободы передвижения» — но также появились две большие проблемы.</p>
      <p>Во-первых, это означально, что левелдизайнеры и художники окружения теперь должны были позаботиться о проработке всех мест, куда игрок мог попасть — от двора до крыши дома. Во-вторых, у игры резко упала производительность — но благодаря работе программистов её удалось оптимизировать. Так, окружение вокруг игрока теперь «пакетировалось», а сканирующие лучи одного и того же направления складывались.</p>
      <p>Помимо этого, разработчикам пришлось ввести новые движения для паркура — например, в таких случаях, когда игрок не может залезть на следующую платформу сразу, и ему остаётся лишь свисать. Всё это требовало расширения алгоритма передвижения.</p>
      <figure>
        <img src="https://leonardo.osnova.io/abeb71a0-a16a-4eef-36c9-ab6ae8cb6458/"/>
      </figure>
      <p>Следующим шагом стала проработка механики прыжков, которая лежала в основе всего паркура. Как отметил Кулон, прыжки от первого лица не настолько интуитивны, нежели в платформерах — из-за искажения перспективы.</p>
      <p>Во время первых тестов игроки прыгали либо слишком рано, либо слишком поздно — из-за чего преодолевание препятствий чрезмерно усложнялось, или, наоборот, упрощалось. Поэтому разработчикам пришлось сгладить некоторые углы, добавив в Dying Light то, что они назвали jump assist — «помощь в прыжках».</p>
      <p>Во-первых, эта система слегка откладывала прыжок, выжидая наилучший для него момент.</p>
      <figure>
        <img src="https://leonardo.osnova.io/80f74570-486b-775e-6a4f-4db5c01e5aa4/"/>
      </figure>
      <p>Во-вторых, она давала возможность совершить прыжок, если игрок только-только начал падение — но с этим нужно было быть аккуратным, так как такое движение «очень плохо выглядело в кооперативе».</p>
      <figure>
        <img src="https://leonardo.osnova.io/9846552a-3b9c-b70a-6dc0-dac432d89185/"/>
      </figure>
      <p>И в-третьих, если игрок хочет отпрыгнуть от препятствия, игра позволяет это сделать. С технической точки зрения, это прыжок в воздухе — но так как подобное движение чувствуется более естественно в геймплее, его решили ввести в систему паркура.</p>
      <figure>
        <img src="https://leonardo.osnova.io/a75fadec-b9a6-d36e-3063-3b726312e38c/"/>
      </figure>
      <h3>Проблемы и решения</h3>
      <p>После того, как игра подбирала нужную анимацию в зависимости от вида препятствия, позиция игрока с ней синхронизировалась. В этот момент персонаж протягивал руки, чтобы зацепиться за край платформы. Действие либо ускорялось, либо замедлялось в зависимости от скорости игрока — чтобы избежать её потери и сделать передвижение более плавным.</p>
      <p>Затем, когда персонаж начинал карабкаться, его анимация вновь сихронизировалась с позицией. Звучит просто, да и выглядит красиво — но на деле это вылилось в ряд проблем.</p>
      <figure>
        <img src="https://leonardo.osnova.io/f029cb9e-3b46-c417-5f88-5cdcc852b65a/"/>
      </figure>
      <p>Анимация паркура включалась, когда герой начинал карабкаться — в это время у игрока отнимался контроль над управлением, и это очень плохо им воспринималось. В итоге разработчикам пришлось ускорить паркур и добавить возможность крутить головой во время воспроизведения анимации — простой трюк, но, как выяснилось, довольно действенный.</p>
      <p>Также из-за того, что игроки зачастую прыгали на препятствия не перпендикулярно их краям, а слегка под углом, возникала проблема с руками — одна обязательно застревала в текстурах, а другая висела в воздухе.</p>
      <figure>
        <img src="https://leonardo.osnova.io/5c5a94a3-97f4-a0ab-afbd-f62beda863d6/"/>
      </figure>
      <p>Так как из-за особенностей движка разработчики не могли рендерить руки в конце фрейма, они пришли к более изобретательному решению — масштабированию модели игрока. Поэтому в моменты карабканья со стороны она выглядела... необычно.</p>
      <figure>
        <video src="https://leonardo.osnova.io/22917b1f-54ee-e400-f088-05a73fa4d2fa/-/format/mp4/" autoplay="" loop=""/>
      </figure>
      <p>А в случае с рукой, которая висела в воздухе, игра просчитывала позицию грани платформы и «переносила» кисть поближе к ней.</p>
      <p>Последние проблемы касались управления на геймпадах. В Techland приняли решение перенести стандартную кнопку прыжка с X на R1 (на Dualshock) — из-за того, что при использовании крестика игрок перемещал большой палец с правого стика и на короткий момент терял управление в воздухе.</p>
      <p>Более того, разработчики добавили возможность зажимать R1 в моменты, когда игрок может попасть сразу в несколько мест — как на скриншоте ниже. В итоге он может зацепиться за грань платформы лишь в том случае, если зажмёт кнопку — иначе произойдёт просто прыжок.</p>
      <figure>
        <img src="https://leonardo.osnova.io/0a1a80e0-b112-7644-0ae4-d7ae11244b20/"/>
      </figure>
      <p>Кулон также упомянул то, что в Techland экспериментировали с введением фрирана из Assassin's Creed, где весь паркур происходит автоматически при зажатии кнопки. По его словам, фича работала «превосходно» — однако так игрок не получал удовольствия от правильного расчёта тайминга во время передвижения, да и никакого навыка от него больше не требовалось.</p>
      <h3>Полировка деталей</h3>
      <p>Как выяснилось во время разработки, очень малый процент игроков в Dying Light сталкивался с укачиванием во время геймплея.</p>
      <blockquote>Со мной такого никогда не случалось, так что представьте моё удивление, когда однажды ко мне приходит коллега и рассказывает историю: «Чувак, я показывал нашу игру на конференции одной из репортёров Polygon. И тут она внезапно побледнела, выбежала из стенда, и её вырвало». Он был в шоке. <br/><br/><br/>Потом журналистка даже написала ему письмо, где сказала, что ей было плохо до конца дня. Это была катастрофа, мы не могли позволить случиться тому, чтобы репортёры выбегали со стенда, а игроков тошнило во время игры. В Techland никто с этим не сталкивался.<cite>Бартош Кулон</cite></blockquote>
      <p>В итоге разработчики почитали несколько статей об укачивании и подготовили билд с исправлениями. Также Techland прибегла к помощи специалистов, которые выяснили, из-за чего конкретно игрокам становилось плохо.</p>
      <p>Во-первых, создатели исправили покачивание камеры — как на гифке ниже.</p>
      <figure>
        <video src="https://leonardo.osnova.io/9e62f793-221c-21a8-2aca-266bdbad3c74/-/format/mp4/" autoplay="" loop=""/>
      </figure>
      <p>Во-вторых, убрали уведение камеры назад во время ускорения игрока вперёд.</p>
      <figure>
        <img src="https://leonardo.osnova.io/a5fd9657-105c-7a0e-8bfa-27065f03cd8f/"/>
      </figure>
      <p>В-третьих, разработчики добавили крохотную точку в центре экрана — чтобы глаза игрока (пусть даже неосознанно) всегда на чём-то фокусировались. Без прицела это происходило хаотично на разных объектах.</p>
      <figure>
        <img src="https://leonardo.osnova.io/177f4c83-1521-b987-06f6-db33dc26a79b/"/>
      </figure>
      <p>Также специально для конференций Techland сделала больше расстояние между экраном и игроком на своих стендах — так как при большом ТВ глаза могут улавливать даже малейшие движения. В итоге, как отметил Кулон, никто не почувствовал укачивание — даже та самая журналистка Polygon.</p>
      <p>Из остальных деталей разработчик также упомянул дополнительные нововведения, призванные компенсировать недостаток контроля над персонажем. К примеру, во время бега среди вертикальных препятствий игрока слегка подталкивает из стороны в сторону, а если на пути встречается ступенька или небольшая кочка, он наступает на неё автоматически, без прыжка.</p>
      <figure>
        <video src="https://giant.gfycat.com/OrangeIdealBoar.mp4" autoplay="" loop=""/>
      </figure>
    </article>
  </body>
</html>