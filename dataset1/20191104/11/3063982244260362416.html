<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://www.golem.de/news/zfs-erklaert-ein-dateisystem-alle-funktionen-1911-144776.html"/>
    <meta property="og:site_name" content="Golem.de"/>
    <meta property="article:published_time" content="2019-11-04T11:05:01+00:00"/>
    <meta property="og:title" content="Ein Dateisystem, alle Funktionen"/>
    <meta property="og:description" content="Um für möglichst redundante und sichere Daten zu sorgen, ist längst keine teure Hardware mehr nötig. Ein Grund dafür ist das Dateisystem ZFS. Es bietet Snapshots,"/>
  </head>
  <body>
    <article>
      <h1>Ein Dateisystem, alle Funktionen</h1>
      <h2>Um für möglichst redundante und sichere Daten zu sorgen, ist längst keine teure Hardware mehr nötig. Ein Grund dafür ist das <a href="https://www.golem.de/specials/dateisystem/">Dateisystem</a> <a href="https://www.golem.de/specials/zfs/">ZFS</a>. Es bietet Snapshots, sichere Checksummen, eigene Raid-Level und andere sinnvolle Funktionen - kann aber zu Anfang überfordern.</h2>
      <address><time datetime="2019-11-04T11:05:01+00:00">04 Nov 2019, 11:05</time> by <a rel="author">Oliver Nickel</a></address>
      <p>Ein möglichst redundantes System für Datensicherheit und Integrität aufzubauen, ist seit einiger Zeit nicht mehr nur eine Sache des richtigen Raid-Verbundes. Auch die Wahl des Dateisystems, mit dem Informationen auf Festplatten und SSDs gespeichert werden, spielt eine große Rolle. Systeme wie Windows und diverse Linux-Distributionen nutzen standardmäßig NTFS respektive Ext4, entsprechend groß ist ihre Verbreitung in der IT.</p>
      <p>Sobald es darum geht, Laufwerke mit verschiedenen Methoden vor Datenverlust zu schützen, kommen aber beide genannten Filesysteme an ihre Grenzen. Aus diesem Grund ist im Bereich der Netzwerkspeicher und Serversysteme auch das Zettabyte File System - ZFS - bekannt. Doch was zeichnet dieses im Vergleich zu NTFS und Ext4 aus?</p>
      <p>Wir denken: Jeder Administrator muss sich damit auseinandersetzen. Allerdings ist das System mit seinen vielen Möglichkeiten sehr komplex, hat einige Einschränkungen und kann daher schnell verwirren. Golem.de gibt eine Übersicht.</p>
      <p>Diverse Funktionen, die Datenredundanz sicherstellen sollen - darunter Snapshots, Copy-on-write oder vom Dateisystem verwaltete Raid-Systeme - gehören zu den Eigenschaften von ZFS. Hier kommt auch ein ähnliches, aber unabhängig entwickeltes Dateisystem ins Spiel: das B-Tree File System, kurz Btrfs.</p>
      <p>Für welches der beiden Systeme wir uns entscheiden, hängt dabei eher von unserem genutzten Betriebssystem ab. ZFS wird etwa unter FreeBSD unterstützt, welches auf diversen NAS-Systemen verbreitet ist. Auch das beliebte NAS-OS FreeNAS unterstützt ZFS nativ. <a href="https://www.golem.de/news/freenas-und-windows-10-der-erste-nas-selbstbau-macht-gluecklich-1903-139995.html">Golem.de konnte sich im Eigenbau</a> bereits einen eigenen Netzwerkspeicher damit erstellen. Auch konnten wir das <a href="https://www.golem.de/news/zfs-ausprobiert-ein-dateisystem-fuers-rechenzentrum-im-privaten-einsatz-1710-129252.html">Dateisystem anderweitig ausprobieren</a>.</p>
      <h4>Wo kommt ZFS her?</h4>
      <p>Nachdem ZFS als Teil des Betriebssystems Solaris durch Oracle gekauft wurde, stellte das Unternehmen die Lizenz des Dateisystems effektiv von Open Source wieder auf ein proprietäres und geschlossenes Modell um und bot dafür keine weiteren Updates an. Das Konzept wurde daher mit dem Open-Source-Projekt Illumos, das auf Opensolaris basiert, später wieder weiterentwickelt.</p>
      <p>Seit 2013 beschäftigt sich das <a href="http://open-zfs.org/wiki/Main_Page">Projekt OpenZFS</a> mit der Weiterentwicklung des Dateisystems. Dabei handelt es sich aber um ein separat erhältliches Paket, das nicht mit der GNU Public License kompatibel ist. Aus diesem Grund ist ZFS zwar mit Linux-Distributionen und auch MacOS kompatibel, wird aber nicht im Linux-Kernel verankert und dort weiterentwickelt. Das System wird derzeit von einer Community gepflegt, die FreeBSD, Linux, MacOS und Windows verwendet.</p>
      <h4>Raid-Z funktioniert ohne zusätzliche Hardware</h4>
      <p>Von Grund auf unterscheidet sich ZFS von Dateisystemen wie NTFS und Ext4. Es ist Volume Manager und Dateisystem in einem, kennt also physische Laufwerke des Hostcomputers und deren logische Partitionen. Damit ermöglicht ZFS beispielsweise eine Raid-Funktion, das sogenannte Raid-Z. Dabei handelt es sich im Prinzip um ein herkömmliches Raid 5 oder Raid 6, allerdings mit einem dynamischen Striping. ZFS schreibt einzelne Blöcke immer als ganzen eigenen Stripe. Damit wird Datenverlust während des Schreibvorgangs verhindert, etwa wenn währenddessen ein Laufwerk ausfällt oder das System beschädigt wird.</p>
      <p>Einen Raid-Z können Anwender mit beliebig vielen Paritätslaufwerken definieren, etwa mit einer, zwei oder mehr Redundanzen. Das kann beispielsweise dann sinnvoll sein, wenn Anwender keinen Raid-Controller auf dem Mainboard selbst oder einen dedizierten Controller verwenden möchten oder können. Mit ZFS kann dabei auch aus einem simplen JBOD-Array - also einer Ansammlung mehrerer physischer Datenträger - ein vom Anwender einzelnes sichtbares logisches Volume, ein Virtual Device (Vdev), erstellt werden. Meist besteht ein Vdef aus einer einzelnen Festplatte oder SSD. Die Zusammenfassung mehrerer logischen Laufwerke wird in ZFS auch Pool oder Zpool genannt. Sie werden über alle darin definierten physischen Datenträger verteilt in Stripes abgelegt - ähnlich eines RAID-0-Systems. Oracle selbst gibt eine <a href="https://docs.oracle.com/cd/E19253-01/819-5461/ftyue/index.html">weiterführende Übersicht</a> über die Fachbegriffe von ZFS.</p>
      <p>ZFS ist dabei auch in der Lage, eine Art Raid 1 aufzuziehen. Möglich ist das mit ZFS Mirror. Dabei werden die Daten des Quellpools bei Schreibvorgängen auch auf redundante Pools repliziert. Sollte so ein Gerät ausfallen, können die Daten von der zusätzlichen Hardware gelesen werden. Ein ZFS Mirror ist dabei in der Lage, auch wesentlich mehr als eine redundante Kopie zu erstellen. Wollen wir ein Datenlaufwerk mit zehn redundanten Laufwerken absichern, können wir dies tun. Wir sollten beachten, dass dies natürlich teuer ist. Hier sollten Administratoren abwägen, wie kritisch ihre Daten sind.</p>
      <p>Doch wie heißt es in der Welt der IT-Administration: Ein Raid ersetzt kein Backup. Auch hier bietet ZFS eine Lösung an, mit Snapshots des Dateisystems.</p>
      <h3>Ein Raid ersetzt kein Backup</h3>
      <p>Doch nicht nur durch Raid eignet sich ZFS gerade für Server und NAS-Systeme. Das Dateisystem unterstützt beispielsweise Snapshots, die den derzeitigen Zustand eines Laufwerks als Backuppunkt abspeichern. Beim initialen Erstellen benötigen Snapshots keinen Platz auf dem Speichermedium. Jedoch wird der benötigte Speicherplatz mit jeder veränderten, erzeugten oder verschobenen Datei innerhalb des vom Snapshot abgedeckten Datensets vergrößert.</p>
      <p>Der von Snapshots belegte Speicher ist <i>read only</i>, belegt also permanent Speicher auf dem Datenträger, der nicht modifiziert werden kann. Das ist nur logisch, wollen wir doch keine Inkonsistenzen in Snapshots haben. Denn damit ist es beispielsweise möglich, einen älteren Zustand des abgebildeten Laufwerks wiederherzustellen.</p>
      <p>Es sollte allerdings beachtet werden: Da Snapshots phyisch nah an den Quelldaten liegen, sollten wir dies nicht als volles Backup betrachten. Per zfs send und zfs receive können Snapshots auf externe Laufwerke ausgelagert und von dort wieder zurückgespielt werden. Diese Replikationsfunktion ermöglicht ein weitaus effizienteres Backup auf komplett unabhänige und physisch getrennte Storage-Systeme.</p>
      <p>ZFS ermöglicht Snapshots, da es ein Copy-on-write-Dateisystem ist. Beim Überschreiben einer Datei kopiert es die neuen Daten zuerst an eine andere Stelle und löscht die ursprünglichen Daten nicht direkt, wie es beispielsweise bei NTFS und ext4 der Fall ist. Sollte das eigene System beim Schreibvorgang abstürzen, ist es so etwa weniger wahrscheinlich, dass Daten verloren gehen.</p>
      <p>Allerdings hat dieser Prozess auch einen Nachteil: Ein in ZFS formatiertes Laufwerk sollte nicht zu 100 Prozent mit Daten belegt sein. Administratoren sprechen auch von der 80-Prozent-Regel. Danach sollten 20 Prozent der Festplatte oder SSD frei bleiben. Der <a href="https://www.youtube.com/watch?v=r0Fdfkq8L-Q">Youtube-Channel 45 Drives</a> hat dies wohl bereits getestet und festgestellt, dass die Leistungseinbußen eines ZFS-Laufwerks in der Praxis aber erst ab etwa 85 bis 90 Prozent Belegung auftreten. Trotzdem: Bei großen Applikationen mit vielen physischen Datenträgern - etwa ein großer Fileserver - sollte dies bei einer Kostenrechnung beachtet werden.</p>
      <p>Wie andere Dateisysteme auch, nutzt ZFS für die Prüfung gespeicherter Dateien Checksummen - in diesem Fall sind diese 256 Bit groß. Sie werden aber nicht zusammen mit den Daten im gleichen Block abgespeichert. Stattdessen werden sie unabhängig von Dateien abgelegt - in über den Datenblöcken liegenden Eltern-Datenblöcken. Das Dateisystem legt dazu mehrere übergeordnete Blöcke an, in denen Informationen zu den Positionen einzelner Daten und eben deren Checksummen für die Prüfung auf ihre Richtigkeit abgelegt werden.</p>
      <p>Jeder Eltern-Block im ZFS-Storage-Pool ist an mehreren Stellen auf dem Datenträger redundant abgelegt und wird seinerseits wieder von der Checksumme in einer Ebene darüber abgesichert. Die Daten selbst sind dabei auf der untersten Ebene des Baumes, den Blättern, abgelegt. Die Wurzel des Baumes ist der sogenannte Überblock, der in sehr vielen Kopien abgelegt wird. Dieses Prinzip wird Merkle-Baum genannt.</p>
      <p>Was der Haltbarkeit von SSDs und HDDs zugutekommt, ist die sogenannte Deduplizierung. Mit Hilfe dieser Funktion werden Daten, die bereits an anderer Stelle auf dem Datenträger vorhanden sind, nicht noch einmal komplett neu geschrieben. Stattdessen legt das System einfach nur einen Zeiger an, der auf den Standort der abgelegten Datenblöcke verweist. Das spart Schreibvorgänge und mindert dadurch den Verschleiß der Hardware. Nicht nur ZFS beherrscht diese Technik, allerdings kann es Deduplizierung schon während eines Schreibvorgangs, also inline, durchführen und muss dies nicht im Nachgang mit einem separaten Task erledigen, das kostet allerdings Rechenleistung.</p>
      <p>Das Verschlüsseln von Daten auf Laufwerken ist in ZFS genauso möglich wie auf vielen anderen Dateisystemen auch. Es ermöglicht zusätzlich die Kompression von Dateien, beispielsweise durch lz4. Das kann sehr viel Speicherplatz auf den Datenträgern einsparen, benötigt allerdings zusätzliche CPU-Leistung, wie das <a href="https://www.servethehome.com/the-case-for-using-zfs-compression/">IT-Magazin Servethehome in der Praxis</a> testen konnte.</p>
      <h4>Die Alternative für viele Linux-Nutzer ist Btrfs</h4>
      <p>Wie anfangs erwähnt, ist ZFS derzeit kein Teil eines Linux-Kernels, da es zum einen von Oracle unter geschlossener Lizenz entwickelt wird und zum anderen als OpenZFS-Projekt, an dem dezentral einige Community-Mitglieder arbeiten.</p>
      <p>Unter anderem deshalb hat sich das B-Tree File System <a href="https://github.com/torvalds/linux/tree/master/fs/btrfs">Btrfs</a> entwickelt, das derzeit Teil von Suse Enterprise Linux ist und seit der Version 12 dort sogar als Standard verwendet wird. Es ist zudem Teil des Linux-Kernels und muss nicht über separat unterstützte Tools installiert werden. Funktional ist das Dateisystem mit ZFS eigentlich identisch, bis auf eine fehlende Inline-Deduplizierung. Auch hier können Raid-Verbunde, Snapshots und Mirroring genutzt werden, wobei auch hier Copy-on-write im Zentrum der Funktionalität steht.</p>
      <p>Ein großes Unternehmen, das Btrfs in angepasster Form in seinen eigenen Rechenzentren verwendet, ist Facebook. Das soziale Netzwerk beschäftigt ein ganzes Entwicklerteam, das nur für das Dateisystem zuständig ist. Der Vorteil: Es wird dadurch ständig und täglich und im weitreichenden praktischen Einsatz weiterentwickelt. Obwohl Btrfs noch vergleichsweise jung ist, hat es dadurch Potenzial, in seiner Reife und Stabilität ZFS irgendwann zu überholen.</p>
      <p>Derzeit teilen sich die beiden Dateisysteme jedoch ihre Nutzerbasis auf. Free-BSD-Systeme wie Heim-NAS-Server oder einige Geräte von Netzwerkanbietern werden weiterhin ZFS verbreiten. Die Linux-Community verwendet lieber Btrfs. Fakt ist: Beide Dateisysteme sind in Sachen Sicherheit und Datenstabilität anderen Systemen voraus, sei es Microsofts NTFS oder Exfat, ext4 und andere Standards.</p>
      <p>Auch Apple entwickelt mit dem <a href="https://www.golem.de/news/apfs-apple-erstellt-eigenes-modernes-dateisystem-1606-121496.html">Apple File System APFS</a> ein Dateisystem, das einige Funktionen von ZFS und Btrfs unterstützt - allem voran Snapshots und die Copy-on-Write-Mechanik. Was hier fehlt, ist etwa die Möglichkeit, redundante RAID-Systeme aufzuspannen und eine von den Daten unabhängige Fehlererkennung durch Checksummen.</p>
      <p>Dort, wo es möglich ist: Administratoren sollten ernsthaft in Betracht ziehen, eines der beiden Dateisysteme in ihrer Netzwerkumgebung zu verwenden. Wie wir erfahren, ist anfangs einige Arbeit notwendig, sich darin zurechtzufinden. Es lohnt sich aber: Wir können mit Snapshots Backups erstellen, können unsere Daten mit einem Dateisystem-Raid redundant speichern und wir können uns sicher sein, dass wir es mit weniger Datenverlust während Schreibvorgängen oder durch Bitkorrumpierung zu tun haben.</p>
    </article>
  </body>
</html>