<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://dtf.ru/gamedev/82687-modelirovanie-podvizhnyh-chastey-i-render-glubin-kak-sozdavalis-podlodki-v-world-of-warships"/>
    <meta property="og:site_name" content="DTF"/>
    <meta property="article:published_time" content="2019-11-19T11:46:14+00:00"/>
    <meta property="og:title" content="Моделирование подвижных частей и рендер глубин: как создавались подлодки в World of Warships"/>
    <meta property="og:description" content="Тонкости разработки подводных машин."/>
  </head>
  <body>
    <article>
      <h1>Моделирование подвижных частей и рендер глубин: как создавались подлодки в World of Warships</h1>
      <address><time datetime="2019-11-19T11:46:14+00:00">19 Nov 2019, 11:46</time> by <a rel="author">Андрей Верещагин</a></address>
      <p>Тонкости разработки подводных машин.</p>
      <p>Сотрудники компании Wargaming написали для DTF колонку, в которой рассказали о создании подлодок в World of Warships. Изначально разработчики не планировали добавлять этот класс кораблей в игру, однако позднее всё-таки «сдались» под просьбами игроков. Это вылилось в освоение новых техник рендера и поиск решений для реалистичного отображения световых эффектов.</p>
      <figure>
        <img src="https://leonardo.osnova.io/695073d6-cf99-97db-ed07-5676d6e01feb/"/>
      </figure>
      <h3>Вступление</h3>
      <p>В World of Warships в угоду балансу эсминцы, линкоры, крейсеры и авианосцы сражаются на равных, имея свои сильные и слабые стороны, хотя в действительности они создавались и применялись для разных задач, не говоря уже о том, что строительство линкора было несоизмеримо по стоимости со строительством, например, эсминца или лёгкого крейсера.</p>
      <p>Один класс кораблей, которого изначально в игре не было — подводные лодки. О нём нас спрашивали фанаты ещё с альфа-тестирования, и мы решили добавить его в игру, хотя исторически этот класс едва ли принимал участие в эскадренных сражениях, ведя войну на истощение на путях сообщения противника. Добавить совершенно новый класс спустя четыре года после релиза игры оказалось задачей не из лёгких.</p>
      <h3>Моделирование</h3>
      <p>Учитывая, что подводные лодки — самые маленькие корабли в игре, процесс их моделирования не кажется слишком сложным. Если с линкором мы справляемся в среднем за шесть месяцев, то на подводную лодку уходит 2–2,5. По полигонам схожая история: подлодка — это 40–70 тысяч треугольников, а линкор занимает до 350–420 тысяч. Но есть другие нюансы, о которых мы начали догадываться, ещё когда делали стимпанк-подлодки для прошлого ивента на Хеллоуин.</p>
      <figure>
        <img src="https://leonardo.osnova.io/90b5aa05-d842-5445-8a13-9eeb1d9447a0/"/>
      </figure>
      <p>У подлодок обнаружилось очень много подвижных частей, состояние которых завит от текущего положения. Есть два типа рулей: направления и глубины. Главное оружие — это торпедные аппараты, которые по умолчанию закрыты крышками, а им тоже необходимо правильно открываться для беспрепятственного запуска торпеды.</p>
      <p>Кроме собственной крышки аппарата есть ещё крышки лёгкого корпуса с различными вариантами открытия или смещения, и у каждой подлодки они работают по-своему. Всё это необходимо достоверно воссоздать с рабочими механизмами, имитирующими правильное открытие всех этих крышек, для соответствия нашим стандартам качества. Тем более, игроки любят рассматривать такие детали.</p>
      <figure>
        <img src="https://leonardo.osnova.io/0da7e797-a1f0-7af0-1b77-9d258c1fa379/"/>
      </figure>
      <p>Чтобы подлодки выглядели достойно в приближении, пришлось поднять количество пикселей на метр, чтобы улучшить детализацию и общее качество текстур.</p>
      <p>Другой проблемой стало большое количество отверстий по всему лёгкому корпусу. Это обусловлено наличием прочного и лёгкого корпусов с большим количеством полостей между ними, надстройкой, рубкой, ограждением.</p>
      <p>Помимо того, что это усложняет создание модели, в эти отверстия можно заглянуть, а в них видно воду. В надводном положении блики солнца и отсутствие сложных отражений и затенений на средних и низких настройках графики давали неприятный эффект, так что мы пошли на компромисс и немного поменяли геометрию с текстурами подлодки так, чтобы вода выглядела нормально.</p>
      <figure>
        <img src="https://leonardo.osnova.io/dfaf8c2e-8ba9-4551-7859-c02e0a18b1bc/"/>
      </figure>
      <p>Артиллерийское вооружение на ПЛ пришлось доработать. Обычно там используются специальные версии корабельных орудийных установок, так что мы смоделировали их в состоянии готовности к погружению. В игре это вооружение всё равно не используется в силу слишком малой эффективности.</p>
      <p>[{"title":"","author":"","image":{"type":"image","data":{"uuid":"6faf05aa-9da8-5791-d533-4e47d8139b60","width":1131,"height":506,"size":1094868,"type":"png","color":"b3b9b3","external_service":[]}}},{"title":"","author":"","image":{"type":"image","data":{"uuid":"9568f4a9-0be4-6a09-3af5-1258eb6a8f9d","width":1280,"height":720,"size":2708042,"type":"png","color":"c5c5c5","external_service":[]}}},{"title":"","author":"","image":{"type":"image","data":{"uuid":"162fc6a7-c86f-6b96-5fca-aef378bbf68e","width":892,"height":335,"size":542878,"type":"png","color":"a5b0ab","external_service":[]}}}]</p>
      <p>Наконец, на подводных лодках есть детали, которые используются преимущественно в порту, а в бою они убираются. Для максимальной достоверности мы смоделировали и их: кнехты, шпили и другое швартовое оборудование, которое спрятано под палубой, а также ограждение, съёмные мачты, гафели, флаги, навигационное оборудование и прочая мелочёвка. Всё это игрок сможет увидеть, рассматривая подлодку в порту между боями.</p>
      <p>[{"title":"","author":"","image":{"type":"image","data":{"uuid":"b0f39281-f6d3-b59c-1979-389f6b4504cb","width":1418,"height":1913,"size":452656,"type":"jpg","color":"292928","external_service":[]}}},{"title":"","author":"","image":{"type":"image","data":{"uuid":"c7ccd084-ce97-f372-f6a5-01e6e0326981","width":1807,"height":1453,"size":432389,"type":"jpg","color":"a2a2a2","external_service":[]}}},{"title":"","author":"","image":{"type":"image","data":{"uuid":"cb1078d8-33d5-2762-4447-a5da5a97929c","width":1770,"height":1681,"size":481802,"type":"jpg","color":"9d9f9f","external_service":[]}}}]</p>
      <h3>Рендер</h3>
      <p>До подлодок у нас не было задачи отрисовывать игроку подводный мир. Теперь же такая задача появилась, да ещё и с высокими требованиями к производительности, и чтобы всё выглядело объёмно, атмосферно и красиво.</p>
      <p>Из-за мельчайших частиц, отражающих свет, и высокой плотности воды, мы видим, как лучи света, переливаясь, проходят сквозь воду.</p>
      <figure>
        <video src="https://giant.gfycat.com/UnhappySnoopyAllosaurus.mp4" autoplay="" loop=""/>
      </figure>
      <p>В реальности волны действуют как множество линз, собирающих свет в более яркие пучки. Физически точная симуляция такого эффекта — задача, непосильная для игровых компьютеров, так что мы применили распространённую художественную технику и рисуем световые лучи в постпроцессинге — уже после расчёта изображения подводного мира.</p>
      <p>Показать подводный мир сложно ещё из-за необходимости отрисовывать множество полупрозрачных объектов: взрывы над водой, такелаж кораблей, поверхность воды, туман, водоросли, пузырьки. Стоит нарушить порядок их рисования — и внимательный игрок заметит этот огрех рендера. В каждой точке экрана, где рисуются прозрачные объекты, видеокарта будет совершать расчёты, кратные числу этих слоёв. Это означает повышенную нагрузку на видеосистему и необходимость в дополнительной оптимизации игры.</p>
      <figure>
        <video src="https://giant.gfycat.com/SelfassuredViciousBat.mp4" autoplay="" loop=""/>
      </figure>
      <p>Очень важный момент для создания атмосферности — это каустика, преломление лучей сквозь воду, создающее характерные блики на поверхности. Здесь мы также не стали проводить физическую симуляцию, но тем не менее, рисунок каустики на каждой карте свой. При этом в его расчётах учитываются ветер, скорость и размер волн, и, конечно, положение солнца.</p>
      <figure>
        <video src="https://giant.gfycat.com/BowedFailingGelada.mp4" autoplay="" loop=""/>
      </figure>
      <p>Очевидно, на глубине видимость не очень хорошая, но нам совсем не хотелось, чтобы игрок постоянно наблюдал лишь тёмную толщу воды. Чтобы побороть данную проблему, мы добавили довольно атмосферный эффект сонара — визуализацию акустической волны, которая пульсацией уходит от подлодки и подчёркивает рельеф дна.</p>
      <figure>
        <video src="https://giant.gfycat.com/InconsequentialThriftyCommabutterfly.mp4" autoplay="" loop=""/>
      </figure>
      <p>И ещё одна деталь — объёмное освещение. Оно не бросается в глаза, но вместе с другими компонентами рендера улучшает восприятие картинки, особенно на высоких настройках графики. Под водой, чтобы определить цвет каждой точки на экране, нужно учесть не только освещение и цвет объекта, который в этой точке виден, но и свет, преломлённый и поглощённый водой между камерой и наблюдаемым объектом. Свет ведь распространяется неравномерно сквозь толщу воды.</p>
      <p>Чтобы учесть это влияние, всё расстояние до объекта разбивается на отрезки и рассчитывается свет, рассеянный и поглощённый на каждом отрезке. На последнем шаге полученные результаты суммируются. Эта операция происходит для каждого пикселя подводного мира, что требует больших ресурсов видеокарты.</p>
      <p>В результате на высоких настройках мы получаем более мягкие переходы освещения, хотя и на низких настройках мы попытались добиться убедительной картинки. Слева — высокие, справа — низкие.</p>
      <p>[{"title":"","author":"","image":{"type":"image","data":{"uuid":"9c2a774f-f10e-f822-a260-ed307c26c4bd","width":1445,"height":914,"size":3066547,"type":"png","color":"263848","external_service":[]}}},{"title":"","author":"","image":{"type":"image","data":{"uuid":"11c0bbba-b33e-6978-5fd8-3e0bd2f4b8b5","width":1445,"height":915,"size":3071008,"type":"png","color":"112c3f","external_service":[]}}}]</p>
      <p>Большинство проведённых доработок рендера сами по себе не особо яркие, но все вместе они работают на создание нужной атмосферы.</p>
      <h3>Звук</h3>
      <p>Ещё один компонент игры, работающий на атмосферу, — это звук. Мы подходим к звуку крайне серьёзно, причём есть три важных момента.</p>
      <ul>
        <li>Мы стараемся применять модульность и активно работаем с миксами, чтобы размер игрового клиента оставался на приемлемом уровне.</li>
        <li>Звук в нашей игре работает не только на атмосферу, но и на обратную связь игроку, причём зачастую не самым прямым образом.</li>
        <li>Мы не гонимся за «документальным» реализмом в звуке, а скорее стараемся брать реалистичные компоненты и дополнять их «киношными». Это распространённая практика: например, в большинстве боевиков взрывы и перестрелки звучат сочнее и ярче, чем в реальности.</li>
      </ul>
      <p>Эти моменты проявились и в работе над подлодками. Помимо трёх состояний (поверхность, перископная глубина, глубина) ещё учитывается положение камеры (например, на перископной глубине субмарина уже под водой, а камера — над водой). Для каждой комбинации создаётся свой микс. Двигатель у подлодки тоже работает по-разному: под водой мы слышим электрический двигатель, причём он специально приглушён, чтобы выделить другие звуки, а над водой работает дизель.</p>
      <p>Как уже упоминалось, мы не преследуем цель создать полную звуковую симуляцию. Поэтому на глубине игрок будет слышать атмосферный эмбиент, а когда на подлодке закончится кислород, к «техническим» звукам сирены будут подмешиваться «человеческие», чтобы создать эффект присутствия и сигнализировать игроку, что у него проблемы.</p>
      <p>Добавлять в игру новый класс — это волнительно, но при этом и крайне интересно. Надеемся, что эта обзорная статья передала вам эмоции, впечатления, а может, и полезные знания, которые мы приобрели, работая над подводными лодками.</p>
    </article>
  </body>
</html>