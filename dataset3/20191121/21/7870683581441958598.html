<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://overclockers.ru/blog/Indigo81/show/31739/shadowsocks-cherez-cloudflare-cdn-povyshaem-bezopasnost-v-seti"/>
    <meta property="og:site_name" content="Overclockers.ru"/>
    <meta property="article:published_time" content="2019-11-21T21:01:00+00:00"/>
    <meta property="og:title" content="Shadowsocks через Cloudflare CDN - повышаем безопасность в Сети"/>
    <meta property="og:description" content="Атака государства на Интернет продолжается, поэтому в этой статье я хочу рассказать об еще одном способе повысить защищенность своих данных и обезопасить он-лайн общение. Речь пойдет о безопасном и очень быстром proxy, созданном нашими китайскими собратьями - Shadowsocks."/>
  </head>
  <body>
    <article>
      <h1>Shadowsocks через Cloudflare CDN - повышаем безопасность в Сети</h1>
      <address><time datetime="2019-11-21T21:01:00+00:00">21 Nov 2019, 21:01</time> by <a rel="author" href="https://overclockers.ru/blog/Indigo81" target="_blank">vanyaindigo</a></address>
      <p>Начислено вознаграждение<br/>Этот материал написан посетителем сайта, и за него начислено <a href="https://overclockers.ru/about/blogs">вознаграждение</a>.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147768_O.jpg"/>
      </figure>
      <h4>реклама</h4>
      <p>Данный материал является продолжением моей предыдущей статьи про Wireguard, использовать для работы мы будем тот же дроплет на Hetzner, поэтому кто еще не научился поднимать и настраивать свой VPS, прошу ознакомиться с предыдущим материалом.</p>
      <p>Так как нашим соседям из Поднебесной гораздо дольше приходится бороться с государственной цензурой в лице Великого Китайского Файервола (т.н. Золотой щит), ими был разработан и успешно применяется для прохождения сквозь Золотой щит шифрующий socks5-proxy под названием Shadowsocks.</p>
      <h4>реклама</h4>
      <p>Основные преимущества Shadowsocks:</p>
      <ul>
        <li>Легкость настройки сервера (конфиг занимает 5 строк в формате json);</li>
        <li>Проходит почти через любые NAT и корпоративные файерволы (пробивал до недавнего времени даже GFW, теперь только с обфускацией);</li>
        <li>Легко настраивать доступ на уровне отдельных программ. В браузере, с помощью дополнений типа FoxyProxy/OmegaSwitchy  — на уровне отдельных адресов по сложным правилам;</li>
        <li>Нет надобности поддерживать постоянный канал, что положительно сказывается на трафике и расходе аккумулятора;</li>
        <li>Очень высокая скорость на мобильных клиентах, вплоть до полной полосы канала.</li>
      </ul>
      <p>К недостаткам можно отнести:</p>
      <ul>
        <li>Нет управления пользователями. Фактически все пользователи подключаются под одним конфигом, к одному порту, по одному паролю (но какая разница, если все пользователи - доверенные);</li>
        <li>Документацию писали китайцы, на китайском английском, с кучей пропущенных пунктов и взаимных противоречий;</li>
        <li>Не проходил официального аудита, т.к. код простой, его смотрела куча народу, но официально нет.</li>
      </ul>
      <h4>реклама</h4>
      <p>Последние два преимущества определили направление материала этой статьи: рассказывать я буду в основном про мобильный клиент, т.к. текущая реализация для маршрутизаторов под OpenWRT оставляет желать лучшего, но клиент под OpenWRT тоже есть, рецепт по настройке можно найти здесь.</p>
      <p>Но самое главное: из этой статьи вы узнаете не только, как поднять сервер и подключить клиент, но и научитесь обфусцировать трафик и пускать его через CDN от Claudflare так, что для DPI будет казаться, что вы подключаетесь по https к обычному сайту, и сайт этот будет не абы какой, а Конституция Российской Федерации! Для чего это нужно? Чтобы избежать атаки сравнений, когда товарищ-майор, имея пакет Яровой и данные о трафике, а так же данные с серверов  (что пока актуально только для ОРИ, поэтому не пользуйтесь российскими сервисами), для того, чтобы найти злобного цифровой сопротивленец, пишущего "Сказочный д...б"  через VPN, сравнивает, с какого ip пользователь это писал и кто в этот момент времени подключался к ip-адресу, с которого это писали. При использовании данного метода весь трафик уходит на один адрес, а приходи с другого.  Cloudflare CDN с 2014 года бесплатно проксирует websocket трафик. Это позволяет скрыть VPS IP от блокировки Роскомнадзором, трафик идет через Cloudflare CDN, но Cloudflare тоже не видит трафик, он только его транзитит между клиентом и прокси сервером.</p>
      <h3>Настройка сервера</h3>
      <h4>реклама</h4>
      <p>Итак, имеется наш VPS за 3€ в месяц на Hetzner, OS Debian 10, настроенный ssh, Unbound, firewall. Запускаем Putty, вводим:</p>
      <blockquote>~# apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y shadowsocks-libev</blockquote>
      <h4>реклама</h4>
      <p>В отличии от прокси, к которому может подключиться любой желающий, в shadowsocks-libev можно и нужно поставить пароль. Также метод шифрования по умолчанию не оптимален. Поэтому обязательно отредактируйте файл конфигурации по адресу <i>/etc/shadowsocks-libev/config.json</i>:</p>
      <blockquote>{<br/>"server":"localhost ",<br/>"server_port":8008,<br/>"password":"пишешь_сюда_какой_нибудь_длинный_пароль",<br/>"timeout":300,<br/>"method":"xchacha20-ietf-poly1305",<br/>"fast_open":true,<br/>"reuse_port": true,<br/>"plugin":"v2ray-plugin", <br/><br/>"nameserver": "127.0.0.1",<br/>"plugin_opts": "server;tls;fast-open;path=/v2ray;host=domain.me;cert=/pass/to/certificate.pem; key=/pass/to/certificate.key;loglevel=none",<br/>"mode": "tcp_only "<br/>  }</blockquote>
      <p>Как видите, параметры не сложно понять:</p>
      <ul>
        <li>В поле "server" вписываем localhost, т.к. перед сервером shadowsocks у нас будет висеть web-сервер.</li>
        <li>В качестве «server_port» нужно указать порт 8008.</li>
        <li>«password» — конечно же, делайте пароль подлиннее и рандомнее (используйте генератор паролей).</li>
        <li>«timeout» — время, после которого закрывается соединение, если не поступило никаких данных. На сервере лучше поставить это значение побольше, но не более 600.</li>
        <li>«method» — алгоритм шифрования,  «xchacha20-ietf-poly1305» очень надёжен, такой трафик никакой злоумышленник не расшифрует, он работает быстро даже на утюге, не поддерживающем аппаратное ускорение шифрования.</li>
        <li>«fast_open» — быстрое открытие соединений, работает на ядрах старше 3.16.</li>
        <li>«reuse_port» — в много поточном приложении позволяет каждому потоку напрямую привязаться к tcp socket’y (адрес:порт). Это позволяет быстрее принимать пакеты.</li>
        <li>«nameserver» — будем использовать свой сервер имен: "127.0.0.1" (это наш Unbound).</li>
        <li>«plugin» — здесь мы указываем используемый в сервере плагин, в нашем случае v2ray-plugin.</li>
        <li>«plugin_opts» — опции плагина. В поле host= нужно вписать имя домена, которым вы управляете (сюрприз: мы будем регистрировать собственный домен). Поле cert= содержит путь до файла сертификата нашего домена, а поле key= путь до ключа сертификата (сертификат и ключ нам выдаст Cloudflare). Данные файлы разместите по адресу /etc/ssl/. </li>
        <li>«mode»:«tcp_only » включает передачу данных только по TCP, так как будем работать по websocket-tls. </li>
      </ul>
      <p>Теперь немного отвлечемся от настройки сервера и пойдем зарегистрируем себе доменное имя. Можно воспользоваться бесплатным сервисом freenom.com, </p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147771_O.png"/>
      </figure>
      <p>который выдаст вам домен на год с последующим продлением, но у меня не получилось, т.к. работающая в автоматическом режиме capcha не хотела признавать во мне человека. Я воспользовался dynadot.com:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147772_O.jpg"/>
      </figure>
      <p>Регистрируете любое имя, только помните, что по этому имени вы будете подключаться к своему серверу. Можно подобрать что-то близкое к служебным доменам Гугла в самой дешевой зоне, это не принципиально.</p>
      <p>Когда зарегистрировали домен, идете на Cloudflare.com, создаете бесплатный аккаунт, и вписываете туда ваш новенький домен.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147773_O.png"/>
      </figure>
      <p>Ждете некоторое время, прежде чем Cloudflare опросит авторитативные DNS-серверы и найдет регистратора вашего домена (может потребоваться несколько минут). После этого откроется следующее окно с выбором тарифного плана - берем бесплатную версию и заполняем две A записи для нашего домена - в них указываем ipv4 адрес нашего сервера Shadowsocks: одна просто domain.me, вторая www.domain.me, плюс еще можно добавить AAAA запись для ipv6 адресации.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147774_O.png"/>
      </figure>
      <p>После этого Cloudflare выдаст нам неймсерверы, которые необходимо скопировать и вставить в панель управления у регистратора домена. Для этого в dynadot вам надо пройти в Управление доменами, щелкнуть на свой зарегистрированный домен, перейти в настройки DNS, нажать Управление и в выпадающем списке выбрать Серверы имен (Nameservers):</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147777_O.png"/>
      </figure>
      <p>Таким же способом вы можете сформировать подпись DNSSEC для своего домена. После этого возвращаемся в панель управления Cloudflare и заходим во вкладку SSL/TLS:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147778_O.png"/>
      </figure>
      <p>В Overview выбираем режим Full (Strict). В разделе Edge Certificates включаем все настройки безопасности: Always Use HTTPS, Minimum TLS Version выбираете 1.3, Opportunistic Encryption, Onion Routing, TLS 1.3, Automatic HTTPS Rewrites (для работы под TLS1.3 нужен клиент Android версии не ниже 8-й). Идете в раздел Origin Certificates нужно выпустить себе сертификат, по которому сервер будет опознавать клиентов.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147779_O.png"/>
      </figure>
      <p>В следующем окне у вас будет два поля: сам сертификат и ключ к нему. Их надо скопировать в два файла: domain.me.pem и domain.me.key.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148073_O.png"/>
      </figure>
      <p>Файлы необходимо разместить на сервере в папке /etc/ssl/ и установить права на чтение. Пути к этим файлам нужно вписать в наш файл конфигурации shadowsocks в раздел «plugin_opts»: поле cert= и поле key=. Также сам сертификат в текстовом виде вам понадобится для мобильного клиента. После завершения возни с сертификатом перейдите во вкладку Firewall консоли Cloudflare и отключите все функции:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147784_O.png"/>
      </figure>
      <p> Теперь вернитесь в консоль вашего сервера.</p>
      <p>Отредактируйте файл /etc/sysctl.conf, вписав в конец следующую информацию:</p>
      <blockquote># tcp bbr<br/><br/>net.core.default_qdisc=fq<br/>net.ipv4.tcp_congestion_control=bbr<br/><br/><br/>net.ipv4.icmp_echo_ignore_all=1<br/>kernel.sysrq=0<br/>kernel.core_uses_pid=1<br/>net.ipv4.tcp_syncookies=1<br/>kernel.msgmnb=65536<br/>kernel.msgmax=65536<br/>kernel.shmmax=68719476736<br/>kernel.shmall=4294967296<br/>net.ipv4.conf.all.accept_source_route=0<br/>net.ipv4.conf.default.accept_source_route=0<br/>net.ipv4.conf.all.log_martians=1<br/>net.ipv4.conf.default.log_martians=1<br/>net.ipv4.conf.all.accept_redirects=0<br/>net.ipv4.conf.default.accept_redirects=0<br/>net.ipv4.conf.all.send_redirects=0<br/>net.ipv4.conf.default.send_redirects=0<br/>net.ipv4.conf.all.rp_filter=0<br/>net.ipv4.conf.default.rp_filter=0<br/>net.ipv4.icmp_echo_ignore_broadcasts=1<br/>net.ipv4.icmp_ignore_bogus_error_responses=1<br/>net.ipv4.conf.all.secure_redirects=0<br/>net.ipv4.conf.default.secure_redirects=0<br/>kernel.randomize_va_space=1<br/><br/>net.ipv4.tcp_fastopen=3<br/><br/>#options for ss<br/><br/>fs.file-max = 51200<br/><br/>net.core.rmem_max = 67108864<br/>net.core.wmem_max = 67108864<br/>net.core.netdev_max_backlog = 250000<br/>net.core.somaxconn = 4096<br/><br/>net.ipv4.tcp_tw_reuse = 1<br/>net.ipv4.tcp_tw_recycle = 0<br/>net.ipv4.tcp_fin_timeout = 30<br/><br/>net.ipv4.tcp_keepalive_time = 1200<br/>net.ipv4.ip_local_port_range = 10000 65000<br/>net.ipv4.tcp_max_syn_backlog = 8192<br/>net.ipv4.tcp_max_tw_buckets = 5000<br/>net.ipv4.tcp_fastopen = 3<br/>net.ipv4.tcp_mem = 25600 51200 102400<br/>net.ipv4.tcp_rmem = 4096 87380 67108864<br/>net.ipv4.tcp_wmem = 4096 65536 67108864<br/>net.ipv4.tcp_mtu_probing = 1</blockquote>
      <p>Не забудьте применить изменения без перезагрузки командой</p>
      <blockquote>~# sysctl -p</blockquote>
      <p>Проверяем результат, команда:</p>
      <blockquote>~# sysctl net.ipv4.tcp_available_congestion_control</blockquote>
      <p>должна показывать net.ipv4.tcp_available_congestion_control = reno cubic bbr.</p>
      <p>Также нам надо установить плагин v2ray, который, собственно, и будет обфусцировать трафик shadowsocks под https. Выполняем следующие команды:</p>
      <blockquote>~# cd /usr/local/bin<br/><br/>~# wget https://github.com/shadowsocks/v2ray-plugin/releases/download/v1.2.0/v2ray-plugin-linux-amd64-v1.2.0.tar.gz &amp;&amp; tar xf v2ray-plugin-linux-amd64-v1.2.0.tar.gz<br/><br/>~# mv v2ray-plugin_linux_amd64 v2ray-plugin<br/><br/>~# setcap 'cap_net_bind_service=+eip' v2ray-plugin</blockquote>
      <p>После этого у вас в папке /usr/local/bin будет лежать файл v2ray-plugin. Его трогать не надо. Сам плагин мы скачиваем вручную из папки релизов https://github.com/shadowsocks/v2ray-plugin/releases. Отсюда же вы можете потом обновлять плагин по мере выхода новых стабильных версий, либо можете скачивать отсюда https://circleci.com/gh/shadowsocks/v2ray-plugin промежуточные (нужно только входить в каждый релиз и в конце адресной строки приписывать <i>#artifacts</i>, чтобы это выглядело вот так: https://circleci.com/gh/shadowsocks/v2ray-plugin/55#artifacts).</p>
      <p>Устанавливаем nginx:</p>
      <blockquote>~# apt install nginx &amp;&amp; systemctl status nginx</blockquote>
      <p>если inactive, значит 80 порт чем-то занят. Для чего нам web-сервер? Для того, чтобы, если кто захочет проверить, что это за сайт такой и "постучит" по нашему адресу, дверь ему бы открыл дворецкий и вежливо  направил на замечательный сайт с Конституцией.</p>
      <p>Открываем файл /etc/nginx/sites-available/default в редакторе, удаляем содержимое и вставляем:</p>
      <blockquote>server {<br/><br/>    listen 80;<br/><br/>    listen [::]:80;<br/><br/>    server_name &lt;домен&gt;;<br/><br/>    return 301 https://$host$request_uri;<br/><br/>    root /usr/share/nginx/html/&lt;домен&gt;;<br/><br/>    index index.html;<br/><br/>} <br/><br/>server {<br/><br/>        listen       443 ssl http2;<br/><br/>        listen       [::]:443 ssl http2;<br/><br/>        server_name  &lt;домен&gt;;<br/><br/>        root         /usr/share/nginx/html/&lt;домен&gt;;<br/><br/>        index index.html;<br/><br/>        ssl_certificate /etc/ssl/&lt;домен&gt;.pem;<br/><br/>        ssl_certificate_key /etc/ssl/&lt;домен&gt;.key;<br/><br/>        ssl_session_cache shared:SSL:1m;<br/><br/>        ssl_session_timeout  10m;<br/><br/>        ssl_ciphers HIGH:!aNULL:!MD5;<br/><br/>        ssl_prefer_server_ciphers on;<br/><br/>        location / {<br/><br/>                proxy_pass http://constitution.ru/;<br/><br/> proxy_redirect off;<br/>        }<br/><br/>        location /v2ray {<br/><br/>            proxy_redirect off;<br/><br/>            proxy_http_version 1.1;<br/><br/>            proxy_pass https://localhost:8008;<br/><br/>            proxy_set_header Host $http_host;<br/><br/>            proxy_set_header Upgrade $http_upgrade;<br/><br/>            proxy_set_header Connection "upgrade";<br/><br/>        }<br/><br/>}</blockquote>
      <p>Здесь на месте &lt;домен&gt; вам надо вписать свой зарегистрированный домен. В месте <i>proxy_pass http://constitution.ru/; </i>мы вписываем любой http сайт для редиректа.</p>
      <p>Также откройте файл /etc/nginx/nginx.conf и раздел events приведите к следующему виду:</p>
      <blockquote>events {<br/>worker_connections 4096;<br/>multi_accept on;<br/>accept_mutex off;<br/>}</blockquote>
      <p>Рестартуем nginx:</p>
      <blockquote>~# systemctl restart nginx</blockquote>
      <p>Запускаем наш сервер:</p>
      <blockquote>~# systemctl enable shadowsocks-libev.service &amp;&amp; systemctl restart shadowsocks-libev &amp;&amp; systemctl status shadowsocks-libev</blockquote>
      <p>Смотрите /var/log/syslog на наличие ошибок. Не забудьте открыть порты 80 и 443 в Firewall.</p>
      <h3>Настройка Android-клиента</h3>
      <p>Андроид-клиент скачиваем отсюда, а отсюда скачиваем плагин v2ray (для iOS используйте Shadowrocket). Настраивается клиент достаточно просто:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147993_O.png"/>
      </figure>
      <p>Задаем имя профиля, в раздел Сервер вписываем наш домен, который привязан к нашему VPS через Cloudflare (резолвится он соответственно будет также ip-адресом, принадлежащим CDN). Удаленный порт 443, пароль - как на сервере, метод шифрования как на сервере.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147994_O.png"/>
      </figure>
      <p>В поле Удаленный DNS указываем ссылку на поднятый на нашем сервере Unbound, просто прописывая 127.0.0.1. Плагин выставляем v2ray и тыкаем на его настройки:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147995_O.png"/>
      </figure>
      <p>Транспортный режим выбираем websocket-tls, Hostname - наш домен, Path - вписываем /v2ray, Concurrent connections можно оставить 1, разницы нет, если увеличивать. И поле сертификат нужно заполнить (скопировать-вставить) нашим сгенерированным Cloudflare сертификатом. Все сохраняем, жмем на кнопку самолетика, если подключились, должны обновляться данные скачивания/загрузки. Если выдало ошибку, перепроверяйте, все ли вы сделали правильно.</p>
      <p>Важный момент по поводу клиента для Андроид. В настройках профиля есть пункт "Режим VPN для выбранных приложений", советую ее включить и выбрать в ней третью опцию "В обход прокси". Туда следует отправить приложения, которые вас идентифицируют, например, мобильный банкинг, Госуслуги и пр.</p>
      <p>По поводу скорости:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/147795_O.png"/>
      </figure>
      <p>Просадка есть, но она не критичная. Гораздо сильнее вырастает ping (у меня где-то в 4 раза). К сожалению, Cloudflare не располагает собственной сетью на территории РФ, из-за этого маршрут трафика может значительно увеличиться, но возможно, что мы придем к такой ситуации, когда другого выхода получить свободный Интернет у нас не останется.</p>
      <h3>Пробуем скрестить Shadowsocks, v2ray и OpenWRT</h3>
      <p>Почему пробуем? Потому что нормального материала на русском языке по данному вопросу мне найти не удалось, все приходится делать по китайским гайдам. Итак, сначала подготовим роутер к установке shadowsocks:</p>
      <blockquote>~# opkg update <br/><br/>~# opkg install ip-full ipset iptables-mod-tproxy libpthread ca-bundle ca-certificates wget</blockquote>
      <p>Добавим ключ подписи gpg автора пакета shadowsocks:</p>
      <blockquote>~# wget -qO /tmp/openwrt-dist.pub http://openwrt-dist.sourceforge.net/openwrt-dist.pub<br/><br/>~# opkg-key add /tmp/openwrt-dist.pub<br/><br/>~# rm /tmp/openwrt-dist.pub</blockquote>
      <p>Нужно открыть Luci, зайти Sysytem -&gt; Software -&gt; Configuration и в раздел "Пользовательские источники" добавить два канала:</p>
      <blockquote>src/gz openwrt_dist http://openwrt-dist.sourceforge.net/packages/base/arm_cortex-a15_neon-vfpv4<br/><br/>src/gz openwrt_dist_luci http://openwrt-dist.sourceforge.net/packages/luci</blockquote>
      <p>Вместо <i>arm_cortex-a15_neon-vfpv4</i><i> </i>в первой строке вам надо вписать свою архитектуру роутера, посмотрев ее в ссылках системных каналов выше. Обновляемся и устанавливаем пакеты:</p>
      <blockquote>~# opkg update <br/><br/>~# opkg install shadowsocks-libev luci-app-shadowsocks</blockquote>
      <p>Пакет v2ray тоже будем ставить руками из гита, присутствуют не все архитектуры, если своей не нашли, значит вам не повезло.</p>
      <blockquote>~#  cd /tmp<br/><br/>~# wget https://github.com/honwen/openwrt-v2ray-plugin/releases/download/v1.1.0/v2ray-plugin_1.1.0-20190219_arm_cortex-a15_neon-vfpv4.ipk<br/><br/>~# mv v2ray-plugin_1.1.0-20190219_arm_cortex-a15_neon-vfpv4.ipk v2ray-plugin.ipk<br/><br/>~# opkg install v2ray-plugin.ipk</blockquote>
      <p>Затем в Luci мы получаем отдельный сервис в разделе Services: Shadowsocks-libev.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148166_O.png"/>
      </figure>
      <p>Раздел Servers Manage заполняется также как и остальные клиенты, если бы не одно большое НО: мне так и не удалось заставить клиент Shadowsocks-libev работать вместе с v2ray плагином. Точнее запустить получилось, но трафика никакого пропустить не смог.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148167_O.png"/>
      </figure>
      <p>Неприятная особенность также в том, что в разделе Адрес сервера нельзя указать доменное имя, принимает только ipv4. Но даже подставив ipv4-адрес Cloudflare, в который резолвится мой домен, мне не удалось подключиться.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148168_O.png"/>
      </figure>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148169_O.png"/>
      </figure>
      <p>Оставлю это для более пытливых умов. Но кое-что на маршрутизаторе стоит сделать: установить шифрующий в DNS-over-TLS резолвер Stubby. Дело в том, что для использования shadowsocks нам постоянно нужно будет разрешать наше доменное имя в системном резолвере. Если у вас стоит маршрутизатор на OpenWRT, по-умолчанию он берет вышестоящие резолверы от провайдера. Так делать небезопасно. Но системный резолвер мало заменить на, к примеру, 1.1.1.1. Ведь в этом случае DNS-запросы все равно будут ходить открытым текстом. Необходимо их шифровать, и для этого-то нам и понадобится Stubby (я уверен, что рано или поздно мы все придем к использованию eSNI, и плагин v2ray реализует его поддержку - таким образом мы зашифруем все оставшиеся данные, и провайдер будет видеть только ip-адрес назначения в сети Cloudflare).</p>
      <blockquote>~# opkg update <br/><br/>~# opkg install getdns stubby</blockquote>
      <p>Теперь надо настроить Stubby: в WinSCP открываете файл /etc/config/stubby. Установите option manual '0' в option manual '1', сохраните изменения. После этого в WinSCP открываете файл /etc/stubby/stubby.yml<br/>Удаляете все содержимое файла и вставляете следующий конфиг.</p>
      <p>Вносим изменения в /etc/config/dhcp:</p>
      <blockquote>option noresolv '1'<br/>list server '127.0.0.1#5453'<br/>list server '/pool.ntp.org/84.200.69.80'</blockquote>
      <p>Далее через графический интерфейс (Luci) идем в Network-&gt;Interface-&gt;Wan, Edit-&gt;Advanced Settings-&gt;Убираем галочку из поля "Use DNS servers advertised by peer" и вписываем в качестве сервера DNS 127.0.0.1. После этого перезагружаем роутер.</p>
      <p>Что ж, если не удалось настроить OpenWRT (он и без обфускации показывал не более 70 Мбит/сек), займемся клиентом для Windows.</p>
      <h3>Клиент Windows</h3>
      <p>Сам клиент можно скачать отсюда, не забывайте сюда заглядывать и обновлять. Сам архив надо обязательно распаковать в отдельную папку. Туда же надо положить файл плагина v2ray, предварительно скачав его отсюда (выбирайте windows-amd64). Переименовывать файл не надо, оставляйте как есть.</p>
      <p>Запустите исполняемый файл Shadowsocks.exe. Раз это первый запуск, появится окно добавления сервера, где нужно ввести доменное имя, порт, пароль и алгоритм шифрования:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148170_O.png"/>
      </figure>
      <p>В разделе Plugin Program указывайте имя исполняемого файла  плагина v2ray, в опциях плагина прописываете:</p>
      <blockquote>tls;fast-open;path=/v2ray;host=domain.me</blockquote>
      <p>Сертификат здесь нигде указывать не нужно (domain.me везде заменяйте на свой домен). </p>
      <p>После нажатия ОК сервер добавится в список слева и окно скроется. При необходимости его можно вызвать нажатием правой кнопкой мыши по значку Windows-клиента Shadowsocks в трее — Servers — Edit Servers.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148171_O.png"/>
      </figure>
      <p>Чтобы инициировать подключение к настроенному серверу, нужно переключить системный прокси: в меню System-Proxy — Global. Пункт Disable выключает проксирование. Также советую, чтобы не запускать программу каждый раз при включении ПК, отметить галкой пункт Start on Boot.</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148172_O.png"/>
      </figure>
      <p>Несмотря на хождение трафика через сеть Cloudflare, пинг вырос незначительно, а скорость так вообще оказалась выше, чем у меня по тарифу:</p>
      <figure>
        <img src="https://st.overclockers.ru/legacy/blog/34342/148198_O.png"/>
      </figure>
      <p>На этом пока все. Если захотите что-то исправить или уточнить, добро пожаловать в комментарии.</p>
    </article>
  </body>
</html>