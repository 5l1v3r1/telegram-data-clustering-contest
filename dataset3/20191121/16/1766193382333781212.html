<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://www.heise.de/security/meldung/RAM-Verschluesselung-in-AMD-Epyc-nicht-sicher-pruefbar-4594130.html"/>
    <meta property="og:site_name" content="Security"/>
    <meta property="article:published_time" content="2019-11-21T16:33:00+00:00"/>
    <meta property="og:title" content="RAM-Verschlüsselung in AMD Epyc nicht sicher prüfbar"/>
    <meta property="og:description" content="Verschlüsselter Hauptspeicher soll virtuelle Cloud-Maschinen abschotten, doch Schwächen bei der kryptografischen Schlüsselkette unterminieren das Konzept."/>
  </head>
  <body>
    <article>
      <h1>RAM-Verschlüsselung in AMD Epyc nicht sicher prüfbar</h1>
      <h2>Verschlüsselter Hauptspeicher soll virtuelle Cloud-Maschinen abschotten, doch Schwächen bei der kryptografischen Schlüsselkette unterminieren das Konzept.</h2>
      <address><time datetime="2019-11-21T16:33:00+00:00">21 Nov 2019, 16:33</time> by <a rel="author">Christof Windeck</a></address>
      <p>Sowohl AMD als auch Intel verkaufen Serverprozessoren mit RAM-Verschlüsselung (Memory Encryption). Letztere soll sensible Daten in virtuellen Maschinen auf Cloud-Servern schützen. AMD Secure Encrypted Virtualization (SEV) und Intels Software Guard Extensions (SGX) zielen darauf ab, Cloud-Server sicher nutzen zu können, ohne dem jeweiligen Rechenzentrum und dessen Administratoren vollständig vertrauen zu müssen. Stattdessen muss man jedoch den kryptografischen Zertifikaten von AMD (SEV) oder Intel (SGX) vertrauen beziehungsweise der sicheren Implementierung der jeweiligen Schutzfunktionen.</p>
      <p>Mittlerweile haben Experten jedoch mehrere Schwachstellen und Sicherheitslücken sowohl bei AMD SEV als auch bei Intel SGX gefunden. So ist etwa <a href="https://www.heise.de/meldung/Neue-Sicherheitsluecken-in-Intel-Prozessoren-ZombieLoad-4421217.html">SGX nicht gegen Seitenkanalangriffe</a> wie Spectre, L1TF und MDS/RIDL/Zombieload gefeit und es gibt auch <a href="https://www.heise.de/meldung/Kritik-an-Intels-Sicherheits-Architektur-Software-Guard-Extensions-3089439.html">grundlegende Kritik am Konzept</a>. Bei künftigen Xeons will Intel neue Verfahren zur RAM-Verschlüsselung einführen wie <a href="https://www.heise.de/meldung/Intel-Prozessoren-sollen-RAM-komplett-verschluesseln-3924494.html">Total Memory Encryption (TME) und Multi-Key Total Memory Encryption (MKTME)</a>.</p>
      <h3>AMD SEV: Schlüsselkette bisher unsicher</h3>
      <p>Bei <a href="https://www.heise.de/meldung/AMD-Zen-RAM-Verschluesselung-fuer-virtuelle-Maschinen-3315469.html">AMD SEV verschlüsselt der Speicher-Controller der Epyc-Prozessoren</a> den RAM-Bereich für jede laufende VM mit einem separaten Schlüssel. Dabei spielt der im Prozessor eingebaute AMD Secure Processor (AMD-SP) alias Platform Security Processor (PSP) eine wichtige Rolle. Denn der PSP verwaltet und schützt die Schlüssel, die der Speicher-Controller verwendet. Außerdem stellt der PSP Funktionen bereit, mit denen der Nutzer einer Cloud-VM nachprüfen kann, dass das RAM seiner VM tatsächlich per SEV verschlüsselt ist (Remote Attestation).</p>
      <p>Nach dem Start einer verschlüsselten VM erzeugt der PSP einen Hash-Wert über die Konfiguration der VM und deren initialen Speicherinhalt; diesen Hash kann der VM-Nutzer mit einem lokal erstellten Hash vergleichen, um sicherzustellen, dass die Konfiguration stimmt. Allerdings muss der Hash über eine sichere Verbindung übertragen werden, die eine Schlüsselkette schützen soll.</p>
      <figure>
        <img src="https://www.heise.de/imgs/18/2/7/9/3/6/7/8/SEK-PEK-PDH-46372ce64b22e28b.png"/>
        <figcaption>Zur "Remote Attestation" der RAM-Verschlüsselung von AMD-Epyc-Prozessoren sind sichere kryptografische Signaturen nötig.<cite>(Bild: Robert Buhren, TU Berlin)</cite></figcaption>
      </figure>
      <p>In dieser Vertrauenskette spielt der von AMD signierte Chip Endorsement Key (CEK) eine Rolle. Sicherheitsforscher zeigen jedoch, dass sich bei der ersten Epyc-Generation (Naples) <a href="https://arxiv.org/abs/1908.11680">der CEK über eine manipulierte PSP-Firmware auslesen</a> lässt.</p>
      <p>Das hebelt die gesamte Vertrauenskette aus, weil ein böswilliger Mitarbeiter eines Cloud-Dienstleisters damit kryptografische Signaturen fälschen kann. Außerdem lässt sich der erbeutete CEK dazu nutzen, um die Daten einer VM bei der Migration auf einen anderen Epyc-Server zu entschlüsseln.</p>
      <p>Zudem hat die PSP keinen Schutz gegen das Einspielen einer älteren Firmware mit Sicherheitslücken (Rollback Protection). Daher lassen sich Epyc-Server auch <a href="https://www.heise.de/meldung/AMD-Epyc-Sicherheits-Update-fuer-RAM-Verschluesselung-4458047.html">mit dem PSP-Patch aus dem Juni 2019</a> nicht gegen das Auslesen des CEK schützen.</p>
      <p>Das Team um Robert Buhren von der TU Berlin macht in seinem Paper Vorschläge, wie sich die Schlüsselkette für Remote Attestation bei AMD SEV schützen lässt. Nach dieser Einschätzung reicht dazu aber kein Firmware-Update aus. Bei GitHub steht ein <a href="https://github.com/RobertBuhren/amd-sev-migration-attack">Proof-of-Concept (PoC) für die "Migration Attack"</a> bereit.</p>
      <h3>I/O-Probleme</h3>
      <p>Die transparente RAM-Verschlüsselung schottet zwar die RAM-Bereiche parallel laufender VMs voneinander ab. Doch I/O-Zugriffe etwa auf Massenspeicher oder PCIe-Netzwerkkarten müssen unverschlüsselt erfolgen, weil solche I/O-Komponenten die Daten nicht entschlüsseln könnten. Daher entschlüsselt die in den Epycs integrierte IOMMU diese I/O-Daten.</p>
      <p>Auch bei I/O-Datentransfers in eine SEV-Enklave lauern Sicherheitsrisiken: <a href="https://www.usenix.org/conference/usenixsecurity19/presentation/li-mengyuan">Sicherheitsforscher beschreiben Angriffsmöglichkeiten</a>, die sie ausnutzen.</p>
      <p>Siehe zu AMD SEV auch:</p>
      <ul>
        <li>heise+: <a href="https://www.heise.de/hintergrund/RAM-Verschluesselung-bei-AMD-und-Intel-4203694.html">RAM-Verschlüsselung bei AMD und Intel</a> (kostenpflichtig)</li>
      </ul>
      <p>(<a href="mailto:ciw@ct.de">ciw</a>)</p>
    </article>
  </body>
</html>