<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta property="og:url" content="https://www.bleepingcomputer.com/news/security/researchers-find-bug-in-qualcomm-code-for-trusted-app/"/>
    <meta property="og:site_name" content="BleepingComputer"/>
    <meta property="article:published_time" content="2019-11-14T16:52:25+00:00"/>
    <meta property="og:title" content="Researchers Find Bug in Qualcomm Code for Trusted App"/>
    <meta property="og:description" content="Researchers stressing the code related to Qualcomm's implementation of the secure execution area on mobile devices found a new vulnerability that could allow access to critical data."/>
  </head>
  <body>
    <article>
      <h1>Researchers Find Bug in Qualcomm Code for Trusted App</h1>
      <address><time datetime="2019-11-14T16:52:25+00:00">14 Nov 2019, 16:52</time> by <a rel="author" href="https://www.bleepingcomputer.com/author/ionut-ilascu/" target="_blank">Ionut Ilascu</a></address>
      <figure>
        <img src="https://www.bleepstatic.com/content/hl-images/2019/11/14/Qualcomm.jpg"/>
      </figure>
      <p>Researchers stressing the code related to Qualcomm's implementation of the secure execution area on mobile devices found a new vulnerability that could allow access to critical data.</p>
      <p>Top smartphone brands like Samsung, LG, or Motorola rely on Qualcomm's implementation of the Trusted Execution Environment (TEE)  based on the TrustZone technology from ARM to store and handle sensitive information in a secure area inside the main processor.</p>
      <p>TEE runs at the same time as the Android operating system and executes only trusted code completely shielded from user-installed apps.</p>
      <p>Trusted apps (trustlets) running in TEE are also isolated from each other through software and cryptography; they receive from regular apps outside this space commands for various purposes (fingerprint recognition, decryption, payment).</p>
      <h3>Not exactly a low-hanging fruit</h3>
      <p>Due to the tight control and restrictions available, access to data in Qualcomm’s “Secure World” is deemed extremely difficult. However, security researchers from Check Point figured out a way to do it.</p>
      <p>After four months of investigating, they managed to execute a trustlet in the "normal world," and loaded in the "secure world" a modified variant they needed to communicate to.</p>
      <p>Running a trustlet (signed ELF file) in the "normal world" was possible with the help of a loader that, among others, handled the memory allocation based on the start addresses and data segments dumped from the "secure world" loading the trustlet.</p>
      <p>A series of problems listed below was solved by patching the target trusted app ('prov') before it loaded in the "secure world:"</p>
      <ul>
        <li>Detect base addresses of a trustlet and cmnlib in the Secure world.</li>
        <li>Dump data segments of a trustlet and cmnlib (library that has the signed ELF format as a trustlet and also loads in memory).</li>
        <li>Execute a trustlet’s syscall in the Normal world.</li>
      </ul>
      <figure>
        <img src="https://www.bleepstatic.com/images/news/u/1100723/TrustletEmulationScheme-CheckPoint.png"/>
        <figcaption>QSEOS patching scheme</figcaption>
      </figure>
      <p>The next step is to load a modified trustlet in the secure area without breaking the chain of trust. An exploit chain of two older vulnerabilities (CVE-2015-6639 and CVE-2016-2431) allowed patching the QSEOS data segment on a Nexus 6 device.</p>
      <figure>
        <img src="https://www.bleepstatic.com/images/news/u/1100723/QSEOS_patching_scheme-CheckPoint.png"/>
        <figcaption>QSEOS patching scheme</figcaption>
      </figure>
      <p>"The target of our attack is the trustlet verification algorithm. We want to “nop” the QSEOS code responsible for calculating the hash block’s signature or for comparing the actual hashes of the segments with the verified ones."</p>
      <p>The exploit enabled the researchers to replace the hash block after the verification but before it was used to validate the segments, Slava Makkaveev writes in a <a href="https://research.checkpoint.com/the-road-to-qualcomm-trustzone-apps-fuzzing/">report</a> today.</p>
      <p>The result of this is the ability to "manually calculate the hash block of a patched trustlet and push it instead of the original one," thus passing verification.</p>
      <p>The effort paid off as the researchers could run a trusted app in the normal environment, load in the trusted zone a signed variant, and the emulator could communicate with it.</p>
      <p>With this setup, the researchers were able to start fuzzing the trustlet in search of exploitable vulnerabilities. This endeavor led to the discovery of CVE-2019-10574, reported to Qualcomm in June and reproducible on Moto G4/G4 Plus (XT1643 and XT1640).</p>
      <p>Check Point was also ran their fuzzer on trusted code running on Samsung and LG devices. This way they found four vulnerabilities in code implemented by Samsung (patched three), one in Motorola devices, one in LG devices (now patched), and another related to LG. All code was sourced by Qualcomm, though.</p>
      <p>The chip maker did not patch right away as Check Point informs that they were notified only yesterday that the flaw has been addressed.</p>
    </article>
  </body>
</html>